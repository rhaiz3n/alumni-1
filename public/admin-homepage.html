<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ADMIN PAGE | TUP - Cavite</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="icon" type="image/png" href="/Logo2.png">

  <!-- Custom unified styles -->
  <style>
    :root {
      --fb-blue:#1877f2;
      --muted:#6c757d;
      --card-bg: #ffffff;
      --card-radius: 14px;
      --shadow: 0 6px 18px rgba(15,23,42,0.08);
    }
    body {
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #bebebe;
      color: #111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Navbar */
    .topbar {
      background: linear-gradient(175deg, #882323 55%, #000000 60%);
      color: white;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      position: sticky;
      top: 0;
      z-index: 1050;
    }
    .topbar .navbar-brand { display:flex; align-items:center; gap:.6rem; }
    .topbar .btn-outline-light { border-color: rgba(255,255,255,0.2); color:white; }
    .topbar .btn-outline-light:hover { background: rgba(255,255,255,0.06); }

    /* Layout */
    .app-container { max-width:1200px; margin: 22px auto; padding: 0 16px; }
    .left-card, .right-card, .feed-card { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: var(--shadow); }

    /* Left Sidebar */
    .left-card { padding: 18px; margin-bottom: 18px; position: sticky; top: 70px; z-index: 1020;}
    .shortcut-btn { border-radius: 10px; background: linear-gradient(180deg,#fff,#f7f9fb); border:1px solid #e6e9ee; padding:12px; text-align:left; display:flex; gap:12px; align-items:center; transition: transform .12s ease, box-shadow .12s ease; cursor:pointer;}
    .shortcut-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(15,23,42,0.06); }

    /* Feed */
    .feed-card { padding: 14px; margin-bottom: 16px; }
    .feed-header { display:flex; gap:12px; align-items:center; }
    .avatar { width:44px; height:44px; border-radius:50%; object-fit:cover; border:2px solid #fff; box-shadow:0 2px 8px rgba(15,23,42,0.06); }
    .feed-title { font-weight:600; font-size:15px; }
    .feed-date { color:var(--muted); font-size:12px; }
    .feed-image { width:100%; border-radius:10px; margin-top:12px; max-height:420px; object-fit:cover; }
    .feed-meta { display:flex; gap:12px; margin-top:10px; color:var(--muted); font-size:13px; align-items:center; }

    /* Right Sidebar */
    .right-card { padding:14px; margin-bottom: 18px; }

    /* Loader */
    #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
    .progress-bar-custom { width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin:auto; }

    /* Responsive */
    @media (max-width:991px) {
      .app-container { padding: 0 12px; }
      .left-column { display:none; }
      .right-column { display:none; }
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div style="text-align:center;">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div style="font-weight:700; letter-spacing:.6px; margin-bottom:8px;">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES ‚Äî CAVITE</div>
      <div style="width:360px; margin: auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" style="margin-top:10px; color:#6b7280;">0%</div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="navbar topbar">
    <div class="container">
      <a class="navbar-brand text-white" href="admin-homepage.html">
        <img src="Logo2.png" alt="Logo" style="height:34px; border-radius:6px;">
        <span style="font-weight:600;">TUP Cavite ‚Äî Admin</span>
      </a>

      <form class="d-flex ms-auto me-3 flex-grow-1" role="search" style="max-width: 600px;">
        <input id="feedSearch" class="form-control" type="search" placeholder="üîç Search events or careers..." oninput="filterFeed()">
      </form>

      <div class="d-flex align-items-center ms-3 gap-2">
        <button id="notificationToggle" class="btn btn-outline-light position-relative">
          <i class="fas fa-bell"></i>
          <span id="inboxBadge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display:none;">0</span>
        </button>
        <button id="signOutBtn" class="btn btn-light btn-sm text-primary">Sign out</button>
      </div>
    </div>
  </nav>

  <!-- Layout -->
  <div class="app-container">
    <div class="row gx-4">

      <!-- Left Sidebar -->
      <div class="col-lg-3 left-column">
        <div class="left-card">
          <div class="d-grid gap-2">
            <div class="shortcut-btn" data-bs-toggle="modal" data-bs-target="#modalEvent"><i class="fa-solid fa-calendar-days fa-lg" style="color:#0b5ed7;"></i><div><strong>Post Event</strong><div class="small" style="color:var(--muted)">Create new event</div></div></div>
            <div class="shortcut-btn" data-bs-toggle="modal" data-bs-target="#modalCareer"><i class="fa-solid fa-briefcase fa-lg" style="color:#198754;"></i><div><strong>Post Career</strong><div class="small" style="color:var(--muted)">New job opportunity</div></div></div>
            <div class="shortcut-btn" data-bs-toggle="modal" data-bs-target="#modalGallery"><i class="fa-solid fa-images fa-lg" style="color:#d63384;"></i><div><strong>Gallery</strong><div class="small" style="color:var(--muted)">Upload images</div></div></div>
            <div class="shortcut-btn" data-bs-toggle="modal" data-bs-target="#modalID"><i class="fa-solid fa-id-card fa-lg" style="color:#6c757d;"></i><div><strong>ID Announcement</strong><div class="small" style="color:var(--muted)">Post ID info</div></div></div>
            <div class="shortcut-btn" data-bs-toggle="modal" data-bs-target="#modalApps"><i class="fa-solid fa-list fa-lg" style="color:#ffc107;"></i><div><strong>Applications</strong><div class="small" style="color:var(--muted)">Career applicants</div></div></div>
            <div class="shortcut-btn" data-bs-toggle="modal" data-bs-target="#modalGcash"><i class="fa-solid fa-credit-card fa-lg" style="color:#0dcaf0;"></i><div><strong>Manage GCash</strong><div class="small" style="color:var(--muted)">Upload QR</div></div></div>
          </div>

          <hr style="margin:14px 0;border-color:#eef2f6;">
          <div class="small" style="color:var(--muted);">Quick Links</div>
          <ul class="list-unstyled mt-2">
            <li><a href="alumni-Database.html" class="text-decoration-none">Alumni Database</a></li>
            <li><a href="jobs-response.html" class="text-decoration-none">Jobs Response</a></li>
            <li><a href="data-registration.html" class="text-decoration-none">Registration</a></li>
            <li><a href="admin-id.html" class="text-decoration-none">ID Request</a></li>
            <li><a href="event-registration.html" class="text-decoration-none">Event Registration</a></li>
            <li><a href="admin-employer.html" class="text-decoration-none">Employer Registration</a></li>
          </ul>
        </div>
      </div>

      <!-- Center Feed -->
      <div class="col-lg-6">
        <div id="feed">
          <!-- feed cards go here -->
        </div>
      </div>

      <!-- Right Sidebar -->
      <div class="col-lg-3 right-column">
        <div class="right-card mb-3">
          <div style="font-weight:700; margin-bottom:8px;">ID Announcements</div>
          <div id="idAnnouncementList" class="small-muted">Loading...</div>
        </div>

        <div class="right-card mb-3">
          <div style="font-weight:700; margin-bottom:8px;">Event Announcements</div>
          <div id="eventList" class="small-muted">Loading...</div>
        </div>

        <div class="right-card">
          <div style="font-weight:700; margin-bottom:8px;">Career Opportunities</div>
          <div id="careerList" class="small-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Inbox Panel -->
  <div id="inboxPanel" class="right-card" style="position:fixed; right:20px; top:70px; width:300px; z-index:1050; display:none;">
    <div style="font-weight:700; margin-bottom:8px;">ADMIN INBOX</div>
    <div style="max-height:400px; overflow:auto;" id="inboxContentList"></div>
  </div>

  <!-- Toast wrapper -->
  <div id="toastWrapper" style="position: fixed; top: 16px; right: 16px; z-index: 13000;"></div>

  <!-- =================== MODALS =================== -->
  <!-- Event Modal -->
  <div class="modal fade" id="modalEvent" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="eventForm" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Post Event</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Event Title</label>
            <select id="title" name="title" class="form-select" required>
              <option value="">-- Choose Event --</option>
              <option value="HOMECOMING EVENT">HOME-COMING EVENT</option>
              <option value="SPORT FEST EVENT">SPORT FEST EVENT</option>
              <option value="MENSBASKETBALL">MEN'S BASKETBALL</option>
              <option value="Other">Other</option>
            </select>
            
            <input type="text" class="form-control mt-2 d-none" id="eventTitleOther" placeholder="Enter custom event title">

            <label class="form-label mt-2">Indicate Type of Event</label>
            <input class="form-control" type="text" id="location" name="location" placeholder="Type of Event" required maxlength="95">

            <label class="form-label mt-2">Event Schedule</label>
            <input class="form-control" type="datetime-local" id="eventDateTime" name="eventDateTime" required>

            <label class="form-label mt-2">Upload Image</label>
            <input class="form-control" type="file" id="eventImage" name="image" accept="image/*" required>

            <label class="form-label mt-2">Description</label>
            <textarea class="form-control" id="description" name="description" rows="3" required></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Publish</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Career Modal -->
  <div class="modal fade" id="modalCareer" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="careerForm" enctype="multipart/form-data">
          <div class="modal-header">
            <h5 class="modal-title">Post Career</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Career Type</label>
            <select id="careerType" name="title" class="form-select" required>
              <option value="">-- Select Career --</option>
              <option value="Electrician">Electrician</option>
              <option value="Mechanic">Mechanic</option>
              <option value="Education">Education</option>
              <option value="Software Developer">Software Developer</option>
              <option value="Network Engineer">Network Engineer</option>
              <option value="Telecommunications Engineer">Telecommunications Engineer</option>
              <option value="Electrical Engineer">Electrical Engineer</option>
              <option value="Maintenance Engineer / Technician">Maintenance Engineer / Technician</option>
              <option value="Other">Other</option>
            </select>
            
            <input type="text" class="form-control mt-2 d-none" id="careerTitleOther" placeholder="Enter custom career type">

            <label class="form-label mt-2">Company Name</label>
            <input class="form-control" type="text" id="careerLink" name="link" placeholder="Company Name">

            <label class="form-label mt-2">Upload Image</label>
            <input class="form-control" type="file" id="careerImage" name="image" accept="image/*" required>

            <label class="form-label mt-2">Description</label>
            <textarea class="form-control" id="careerDesc" name="description" rows="3" required></textarea>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" type="submit">Publish</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Gallery Modal -->
  <div class="modal fade" id="modalGallery" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Gallery Posting ‚ÄúMax 25 Pictures per post‚Äù</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="uploadForm" class="mb-3">
            <label class="form-label">Select Images</label>
            <input class="form-control" type="file" name="images" multiple accept="image/*" required>
            <div class="mt-2 d-flex justify-content-end">
              <button class="btn btn-primary" type="submit">Upload Images</button>
            </div>
          </form>
          <div id="galleryGrid" class="row g-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ID Announcement Modal -->
  <div class="modal fade" id="modalID" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="idPostForm" class="modal-form">
          <div class="modal-header"><h5 class="modal-title">Post ID Announcement</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
          <div class="modal-body">
            <label class="form-label">Title</label>
            <input class="form-control" name="title" required>
            <label class="form-label mt-2">Description</label>
            <textarea class="form-control" name="description" rows="4" required></textarea>
            <div id="idPostResult" class="mt-2"></div>
          </div>
          <div class="modal-footer"><button type="submit" class="btn btn-warning">üì© Post Announcement</button></div>
        </form>
      </div>
    </div>
  </div>

  <!-- Admin Applications Modal -->
  <div class="modal fade" id="modalApps" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Career Applications</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <table class="table table-striped">
            <thead>
              <tr><th>Full Name</th><th>Phone</th><th>Email</th><th>Resume</th><th>Submitted At</th></tr>
            </thead>
            <tbody id="adminApplicationsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- GCash Modal -->
  <div class="modal fade" id="modalGcash" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Manage GCash QR Code</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body text-center">
          <button class="btn btn-outline-primary mb-2" onclick="toggleEdit()">Upload GCash QR Code</button>
          <div id="editSection" style="display:none;">
            <input type="file" id="gcashUpload" accept="image/*" class="form-control mb-2">
            <div class="d-flex gap-2 justify-content-center">
              <button class="btn btn-success" onclick="saveImage()">Save</button>
              <button class="btn btn-secondary" onclick="closeEdit()">Close</button>
            </div>
            <div id="previewBox" class="mt-2">No QR uploaded</div>
          </div>
          <div class="mt-3">
            <button id="disableGcashBtn" class="btn btn-danger" onclick="toggleGcash(this)">Disable User GCash Button</button>
          </div>
        </div>
      </div>
    </div>
  </div>


  <!-- CONFIRM modal (custom) -->
  <div id="confirmModal" class="d-none">
    <!-- re-used confirm uses simple overlay created in JS -->
  </div>

  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Bootstrap 5 bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /***********************
   * ADMIN HOMEPAGE LOGIC
   * Single file: feed, modals, gallery, apps, gcash, notifications
   ***********************/

  // --- Helper: toast notifications (small custom) ---
  function showToast(message, type = 'info') {
    // types: info, success, error, warning
    const container = document.getElementById('toast-container');
    if (!container) return;
    const div = document.createElement('div');
    div.className = 'alert alert-' + (type === 'error' ? 'danger' : (type === 'warning' ? 'warning' : (type === 'success' ? 'success' : 'info')));
    div.style.minWidth = '220px';
    div.style.marginTop = '8px';
    div.innerText = message;
    container.appendChild(div);
    setTimeout(() => div.remove(), 4000);
  }

  // --- Simple confirm overlay (re-usable) ---
  function showConfirm(message, onConfirm) {
    const overlay = document.createElement('div');
    overlay.style.position = 'fixed';
    overlay.style.left = 0;
    overlay.style.top = 0;
    overlay.style.right = 0;
    overlay.style.bottom = 0;
    overlay.style.background = 'rgba(0,0,0,0.4)';
    overlay.style.zIndex = 2000;
    overlay.className = 'd-flex justify-content-center align-items-center';

    const box = document.createElement('div');
    box.className = 'bg-white p-3 rounded shadow';
    box.style.maxWidth = '420px';
    box.innerHTML = `<p class="mb-3">${message}</p>`;
    const yes = document.createElement('button');
    yes.className = 'btn btn-danger me-2';
    yes.innerText = 'Yes';
    const no = document.createElement('button');
    no.className = 'btn btn-secondary';
    no.innerText = 'No';
    box.appendChild(yes);
    box.appendChild(no);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    yes.onclick = () => { overlay.remove(); onConfirm(); };
    no.onclick = () => overlay.remove();
  }

  // --- Sign out logic (simple) ---
  document.getElementById('signOutBtn').addEventListener('click', () => {
    // clear session-like storage (adjust to your auth mechanism if needed)
    sessionStorage.clear();
    localStorage.removeItem('gcashEnabled');
    window.location.href = 'homepage.html';
  });

  // --- Inbox (notifications) toggling ---
  const inboxPanel = document.getElementById('inboxPanel');
  const notificationToggle = document.getElementById('notificationToggle');
  notificationToggle?.addEventListener('click', () => {
    inboxPanel.classList.toggle('show');
  });

  // --- Parse flexible datetime strings into a Date (robust) ---
  function parseFlexibleDateTime(input) {
    if (!input && input !== 0) return null;
    if (input instanceof Date) return isNaN(input.getTime()) ? null : input;
    if (typeof input === 'number' || /^\d+$/.test(String(input).trim())) {
      const n = Number(input);
      const d = new Date(n);
      if (!isNaN(d.getTime())) return d;
    }
    const s = String(input).trim();
    // ISO-like
    const iso = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})[T\s](\d{1,2}):(\d{2})(?::(\d{2}))?Z?$/);
    if (iso) {
      const [, yy, mm, dd, hh, mi, ss='0'] = iso;
      return new Date(Number(yy), Number(mm)-1, Number(dd), Number(hh), Number(mi), Number(ss));
    }
    // mysql datetime
    const my = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if (my) { const [, yy, mm, dd, hh, mi, ss='0'] = my; return new Date(Number(yy), Number(mm)-1, Number(dd), Number(hh), Number(mi), Number(ss)); }
    // fallback
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  }

// --- LOAD FEED (events + careers) ---
async function loadFeed() {
  const container = document.getElementById('feed');
  container.innerHTML = '<div class="text-center py-5 text-muted">Loading feed...</div>';

  try {
    const [eventsRes, careersRes] = await Promise.all([
      fetch('/api/events'),
      fetch('/api/careers/all')
    ]);
    if (!eventsRes.ok || !careersRes.ok) throw new Error('Failed to fetch feed data');

    const { events = [] } = await eventsRes.json();
    const { careers = [] } = await careersRes.json();

    const formattedEvents = (events || []).map(e => ({ ...e, type: 'Event' }));
    const formattedCareers = (careers || []).map(c => ({ ...c, type: 'Career' }));
    const feed = [...formattedEvents, ...formattedCareers]
      .sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));

    if (!feed.length) {
      container.innerHTML = '<div class="text-center py-5 text-muted">No posts yet.</div>';
      return;
    }

    container.innerHTML = feed.map((post, index) => {
      let badgeClass = post.type === 'Career' ? 'success' : 'primary';
      let imgSrc = post.type === 'Career'
        ? `/api/careers/image/${post.id}`
        : `/api/events/image/${post.id}`;

      // compute deadline/time for countdown
      let deadlineDate = null;
      if (post.type === 'Career') {
        const posted = parseFlexibleDateTime(post.datePosted) || new Date();
        deadlineDate = new Date(posted.getTime() + 5 * 24 * 60 * 60 * 1000);
      } else if (post.type === 'Event') {
        const raw = post.eventDateTime || post.datePosted;
        deadlineDate = parseFlexibleDateTime(raw);
      }
      const deadlineMs = deadlineDate ? deadlineDate.getTime() : '';

      const title = (post.title || '').toString();
      const desc = (post.description || '').toString();

      return `
        <div class="feed-card" id="post-${post.type}-${post.id}">
          
          <!-- Header -->
          <div class="feed-header">
            <img src="Logo2.png" class="avatar" alt="Avatar">
            <div>
              <div class="feed-title">
                TUP Cavite Alumni Association
                <span class="badge bg-${badgeClass} ms-2">${post.type}</span>
              </div>
              <div class="feed-date">Posted: ${new Date(post.datePosted).toLocaleString()}</div>
            </div>
            <button class="btn delete-btn-small ms-auto" onclick="deletePost('${post.type}', ${post.id})">‚úñ</button>
          </div>

          <!-- Image -->
          ${imgSrc ? `<img src="${imgSrc}" class="feed-image" alt="post image">` : ''}

          <!-- Content -->
          <div class="feed-content">
            <p class="mb-1"><strong>${title}</strong></p>
            <p class="small-muted mb-2">${desc}</p>
            ${
              post.type === 'Event'
                ? `<p class="small-muted">üìç ${post.location || 'N/A'} | üóì ${post.eventDateTime || '‚Äî'}</p>`
                : `<p class="small-muted">üè¢ ${post.link || 'Company N/A'}</p>`
            }
          </div>

          <!-- Countdown -->
          <div class="feed-meta">
            ‚è≥ <span class="countdown" data-time="${deadlineMs}" id="countdown-${index}"></span>
          </div>
        </div>
      `;
    }).join('');

    // update countdowns every second
    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll('.countdown').forEach(el => {
        const ms = Number(el.dataset.time);
        if (!ms || isNaN(ms)) { el.textContent = '‚Äî'; return; }
        const diff = ms - now;
        const card = el.closest('.feed-card');

        if (diff <= 0) {
          el.textContent = '‚ùå Closed';
          if (card) card.classList.add('grayscale');
          return;
        }

        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);

        el.textContent = days > 0
          ? `${days}d ${hours}h ${minutes}m ${seconds}s left`
          : `${hours}h ${minutes}m ${seconds}s left`;
      });
    }
    updateCountdowns();
    if (window._feedCountdownInterval) clearInterval(window._feedCountdownInterval);
    window._feedCountdownInterval = setInterval(updateCountdowns, 1000);

  } catch (err) {
    console.error('Failed to load feed:', err);
    document.getElementById('feed').innerHTML = '<div class="text-center py-5 text-danger">‚ö†Ô∏è Failed to load feed.</div>';
  }
}

  // --- Delete post (Event or Career) ---
  async function deletePost(type, id) {
    showConfirm('‚ùóAre you sure you want to delete this post?', async () => {
      try {
        const url = type === 'Event' ? `/api/events/${id}` : `/api/careers/${id}`;
        const res = await fetch(url, { method: 'DELETE' });
        if (!res.ok) {
          const text = await res.text().catch(()=>null);
          throw new Error(text || 'Delete failed');
        }
        document.getElementById(`post-${type}-${id}`)?.remove();
        showToast('‚úÖ Post deleted successfully', 'success');
      } catch (err) {
        console.error('Delete error:', err);
        showToast('‚ùå Failed to delete post', 'error');
      }
    });
  }

  // --- GALLERY: load, upload, delete ---
  async function loadGallery(containerEl = document.getElementById('galleryGrid')) {
    containerEl.innerHTML = '<div class="col-12 text-center text-muted py-3">Loading gallery...</div>';
    try {
      const res = await fetch('/api/gallery');
      if (!res.ok) throw new Error('Gallery fetch failed');
      const { items = [] } = await res.json();
      if (!items.length) {
        containerEl.innerHTML = '<div class="col-12 text-center text-muted py-3">No images</div>';
        return;
      }
      containerEl.innerHTML = items.map(it => `
        <div class="col-6 col-md-4 col-lg-3">
          <div class="card gallery-thumb">
            <img src="${it.image}" class="card-img-top" alt="gallery">
            <div class="card-body p-2 d-flex justify-content-between align-items-center">
              <small class="text-muted">${new Date(it.datePosted).toLocaleDateString()}</small>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteImage(${it.id})">üóë</button>
            </div>
          </div>
        </div>
      `).join('');
    } catch (err) {
      console.error('Gallery load error:', err);
      containerEl.innerHTML = '<div class="col-12 text-center text-danger py-3">Failed to load gallery</div>';
    }
  }

  async function deleteImage(id) {
    showConfirm('Delete this image?', async () => {
      try {
        const res = await fetch(`/api/gallery/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        showToast('‚úÖ Image deleted', 'success');
        loadGallery();
      } catch (err) {
        console.error('Delete image error:', err);
        showToast('‚ùå Failed to delete image', 'error');
      }
    });
  }

  // upload form
  document.getElementById('uploadForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const input = this.elements['images'];
    if (!input || !input.files.length) { showToast('Select images first', 'warning'); return; }
    const fd = new FormData();
    for (const f of input.files) fd.append('images', f);
    try {
      const res = await fetch('/api/gallery/add-multiple', { method: 'POST', body: fd });
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Upload failed');
      showToast('‚úÖ Images uploaded', 'success');
      this.reset();
      loadGallery();
    } catch (err) {
      console.error('Upload error:', err);
      showToast('‚ùå Upload failed', 'error');
    }
  });

  // --- ID Announcements: load & post & delete ---
  async function loadIdAnnouncements() {
    const container = document.getElementById('idAnnouncementList');
    container.innerHTML = 'Loading...';
    try {
      const res = await fetch('/api/admin/id-announcements');
      if (!res.ok) throw new Error('fetch failed');
      const { announcements = [] } = await res.json();
      if (!announcements.length) { container.innerHTML = '<div class="text-muted">No announcements</div>'; return; }
      container.innerHTML = announcements.map(a => `
        <div class="mb-2 p-2 border rounded">
          <div class="d-flex justify-content-between">
            <strong>${a.title}</strong>
            <small class="text-muted">${new Date(a.datePosted).toLocaleDateString()}</small>
          </div>
          <div class="small-muted mt-1">${a.description}</div>
          <div class="mt-2 text-end">
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAnnouncement(${a.id})">üóë Delete</button>
          </div>
        </div>
      `).join('');
    } catch (err) {
      console.error('ID announcements load error:', err);
      container.innerHTML = '<div class="text-danger">Failed to load</div>';
    }
  }

  async function deleteAnnouncement(id) {
    showConfirm('Delete this announcement?', async () => {
      try {
        const res = await fetch(`/api/admin/id-announcement/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error('Delete failed');
        showToast('‚úÖ Deleted', 'success');
        loadIdAnnouncements();
      } catch (err) {
        console.error('Delete announcement error:', err);
        showToast('‚ùå Failed to delete', 'error');
      }
    });
  }

  // ID Post form submit
  document.getElementById('idPostForm')?.addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(this).entries());
    if (!data.title || !data.description) { document.getElementById('idPostResult').textContent = 'Fill all fields'; return; }
    const submitBtn = this.querySelector('button[type="submit"]');
    const orig = submitBtn.textContent;
    submitBtn.textContent = 'Posting...'; submitBtn.disabled = true;
    try {
      const res = await fetch('/api/admin/id-announcement', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(data)
      });
      const json = await res.json();
      if (!res.ok) throw new Error(json.error || 'Failed to post');
      document.getElementById('idPostResult').textContent = '‚úÖ Posted!';
      showToast('‚úÖ ID announcement posted', 'success');
      setTimeout(()=> { const bs = bootstrap.Modal.getInstance(document.getElementById('modalID')); bs?.hide(); }, 900);
      loadIdAnnouncements();
    } catch (err) {
      console.error('ID post error:', err);
      document.getElementById('idPostResult').textContent = '‚ùå Error posting';
      showToast('‚ùå Failed to post ID announcement', 'error');
    } finally {
      submitBtn.textContent = orig; submitBtn.disabled = false;
      this.reset();
      setTimeout(()=> document.getElementById('idPostResult').textContent = '', 2000);
    }
  });

  // --- Events & Careers load (summaries on right side) ---
  async function loadEvents() {
    const container = document.getElementById('eventList');
    try {
      const res = await fetch('/api/events');
      if (!res.ok) throw new Error('fetch failed');
      const { events = [] } = await res.json();
      container.innerHTML = events.length ? events.map(e => `<div class="mb-2"><strong>${e.title}</strong><div class="small-muted">${new Date(e.datePosted).toLocaleDateString()}</div></div>`).join('') : '<div class="text-muted">No events</div>';
    } catch {
      container.innerHTML = '<div class="text-danger">Failed to load events</div>';
    }
  }

  async function loadCareers() {
    const container = document.getElementById('careerList');
    try {
      const res = await fetch('/api/careers/all');
      if (!res.ok) throw new Error('fetch failed');
      const { careers = [] } = await res.json();
      container.innerHTML = careers.length ? careers.slice(0,10).map(c => `<div class="mb-2"><strong>${c.title}</strong><div class="small-muted">${new Date(c.datePosted).toLocaleDateString()}</div></div>`).join('') : '<div class="text-muted">No careers</div>';
    } catch {
      container.innerHTML = '<div class="text-danger">Failed to load careers</div>';
    }
  }

  // --- Applications modal: load apps into table ---
  async function loadApplications() {
    const tbody = document.getElementById('adminApplicationsTableBody');
    tbody.innerHTML = '<tr><td colspan="5">‚è≥ Loading...</td></tr>';
    try {
      const res = await fetch('/api/admin-applications', { credentials: 'include' });
      if (!res.ok) throw new Error('fetch failed');
      const data = await res.json();
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5">No applications</td></tr>';
        return;
      }
      tbody.innerHTML = '';
      data.forEach(app => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${(app.firstName || '') + ' ' + (app.lastName || '')}</td>
          <td>${app.phoneNo || ''}</td>
          <td>${app.email || ''}</td>
          <td>${app.resume ? `<a href="${app.resume.startsWith('/')?app.resume:'/uploads/resumes/'+app.resume}" target="_blank">View Resume</a>` : 'No Resume'}</td>
          <td>${app.submittedAt ? new Date(app.submittedAt).toLocaleString() : ''}</td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error('Applications load error:', err);
      tbody.innerHTML = '<tr><td colspan="5" class="text-danger">Failed to load applications</td></tr>';
    }
  }

  // When applications modal opens, fetch apps
  const appsModalEl = document.getElementById('modalApps');
  appsModalEl?.addEventListener('show.bs.modal', loadApplications);

// ===== Event Form: Replace "Other" with custom value =====
document.getElementById("eventForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const select = document.getElementById("title");
  const other = document.getElementById("eventTitleOther");

  if (select.value === "Other" && other.value.trim()) {
    formData.set("title", other.value.trim()); // replace value before sending
  }

  try {
    const res = await fetch("/api/events/add", {
      method: "POST",
      body: formData,
      credentials: "include" // ensure session is sent
    });

    if (!res.ok) throw new Error("Failed to post event");
    this.reset();
    document.getElementById("eventTitleOther").classList.add("d-none"); // hide Other input
    bootstrap.Modal.getInstance(document.getElementById("modalEvent")).hide();
    loadFeed(); // refresh feed without reloading
  } catch (err) {
    console.error("Event submission error:", err);
  }
});

// ===== Career Form: Replace "Other" with custom value =====
document.getElementById("careerForm").addEventListener("submit", async function (e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  const select = document.getElementById("careerType");
  const other = document.getElementById("careerTitleOther");

  if (select.value === "Other" && other.value.trim()) {
    formData.set("title", other.value.trim()); // replace value before sending
  }

  try {
    const res = await fetch("/api/careers/add", {
      method: "POST",
      body: formData,
      credentials: "include" // ensure session is sent
    });

    if (!res.ok) throw new Error("Failed to post career");
    this.reset();
    document.getElementById("careerTitleOther").classList.add("d-none"); // hide Other input
    bootstrap.Modal.getInstance(document.getElementById("modalCareer")).hide();
    loadFeed(); // refresh feed without reloading
  } catch (err) {
    console.error("Career submission error:", err);
  }
});


  // --- GCash utilities ---
  function toggleEdit() {
    const s = document.getElementById('editSection');
    s.style.display = s.style.display === 'none' || s.style.display === '' ? 'block' : 'none';
  }
  function closeEdit() { document.getElementById('editSection').style.display = 'none'; }

  function saveImage() {
    const file = document.getElementById('gcashUpload').files[0];
    if (!file) return alert('No file selected!');
    const reader = new FileReader();
    reader.onload = () => {
      localStorage.setItem('gcashImage', reader.result);
      document.getElementById('previewBox').innerHTML = `<img src="${reader.result}" style="max-width:200px" />`;
      showToast('‚úÖ GCash QR saved locally', 'success');
    };
    reader.readAsDataURL(file);
  }

  function toggleGcash(button) {
    const cur = localStorage.getItem('gcashEnabled') === 'true';
    const next = !cur;
    localStorage.setItem('gcashEnabled', next);
    button.textContent = next ? 'Disable User GCash Button' : 'Enable User GCash Button';
    showToast(`‚úîÔ∏è GCash ${next ? 'enabled' : 'disabled'}`, 'success');
  }

  // initialize GCash button state
  (function initGcashState() {
    if (localStorage.getItem('gcashEnabled') === null) localStorage.setItem('gcashEnabled','true');
    const btn = document.getElementById('disableGcashBtn');
    if (btn) btn.textContent = localStorage.getItem('gcashEnabled') === 'true' ? 'Disable User GCash Button' : 'Enable User GCash Button';
    const preview = localStorage.getItem('gcashImage');
    if (preview) document.getElementById('previewBox').innerHTML = `<img src="${preview}" style="max-width:200px" />`;
  })();

  // --- Notification (inbox) system + socket.io real-time ---
  function initNotificationSystem() {
    const inboxList = document.getElementById('inboxContentList');
    const badge = document.getElementById('inboxBadge');

    function updateBadge() {
      const count = inboxList.querySelectorAll('.inbox-item').length;
      badge.textContent = count;
      badge.style.display = count > 0 ? 'inline-block' : 'none';
    }

    function renderNotification(notif) {
      const item = document.createElement('div');
      item.className = 'inbox-item p-2 border-bottom cursor-pointer';
      item.innerHTML = `
        <div class="d-flex align-items-start">
          <div class="me-2"><i class="fas fa-bell fa-lg text-primary"></i></div>
          <div class="flex-fill">
            <div class="fw-bold">${notif.name || 'Notification'}</div>
            <div class="small-muted">${notif.message || ''}</div>
            <div class="small text-muted">${new Date(notif.createdAt || Date.now()).toLocaleString()}</div>
          </div>
        </div>
      `;
      item.addEventListener('click', () => {
        fetch(`/api/notifications/${notif.id}`, { method: 'DELETE' }).catch(()=>{});
        item.remove();
        updateBadge();
        if (notif.link) window.location.href = notif.link;
      });
      inboxList.prepend(item);
      updateBadge();
    }

    // Fetch initial inbox
    fetch('/api/admin/inbox')
      .then(r => r.ok ? r.json() : Promise.reject('Failed'))
      .then(data => {
        data.reverse().forEach(renderNotification);
      }).catch(e => {
        console.warn('Failed to load inbox', e);
      });

    // socket.io
    try {
      const socket = io();
      socket.on('newNotification', (n) => {
        renderNotification(n);
      });
    } catch (err) {
      console.warn('Socket.io not available', err);
    }

    // clear inbox action
    document.getElementById('clearInboxBtn')?.addEventListener('click', () => {
      showConfirm('Clear all notifications?', async () => {
        try {
          const res = await fetch('/api/notifications/clear', { method: 'DELETE' });
          const data = await res.json();
          if (data.success) {
            document.getElementById('inboxContentList').innerHTML = '';
            updateBadge();
            showToast('‚úÖ Inbox cleared', 'success');
          } else throw new Error('clear failed');
        } catch (err) {
          showToast('‚ùå Failed to clear inbox', 'error');
        }
      });
    });
  }

  // --- Initialize everything on DOM load ---
  document.addEventListener('DOMContentLoaded', () => {
    if (sessionStorage.getItem('userRole') !== 'admin') {
      alert("‚õî Access denied. Admins only!");
      window.location.href = 'homepage.html';
    }


    loadFeed();
    loadGallery();
    loadIdAnnouncements();
    loadEvents();
    loadCareers();
    initNotificationSystem();

    // Ensure modals close properly when clicking outside etc handled by bootstrap automatically

    // Small UX: open gallery modal loads gallery grid
    const galleryModalEl = document.getElementById('modalGallery');
    galleryModalEl?.addEventListener('show.bs.modal', () => loadGallery());

    // reload feed when any modal hides (to reflect changes)
    document.querySelectorAll('.modal').forEach(m => {
      m.addEventListener('hidden.bs.modal', () => {
        loadFeed();
        loadEvents();
        loadCareers();
        loadIdAnnouncements();
      });
    });
  });

  // Expose deletePost & deleteImage functions to global (already declared) so inline onclick works
  window.deletePost = deletePost;
  window.deleteImage = deleteImage;
  window.toggleEdit = toggleEdit;
  window.closeEdit = closeEdit;
  window.saveImage = saveImage;
  window.toggleGcash = toggleGcash;
  window.loadGallery = loadGallery;
  window.loadFeed = loadFeed;
  window.loadIdAnnouncements = loadIdAnnouncements;

    /*******************************
   * Loader progress
   *******************************/
  document.addEventListener('DOMContentLoaded', () => {
    let p = 0;
    const bar = document.getElementById('progress-bar');
    const pct = document.getElementById('percentage');
    const wrap = document.getElementById('loader-wrapper');
    const iv = setInterval(() => {
      p = Math.min(100, p + Math.floor(Math.random()*6) + 2);
      bar.style.width = p + '%';
      pct.textContent = p + '%';
      if (p >= 100) {
        clearInterval(iv);
        wrap.style.display = 'none';
      }
    }, 70);
  });

  // ===== Event Modal: Toggle Other Input =====
document.getElementById("title").addEventListener("change", function () {
  const otherInput = document.getElementById("eventTitleOther");
  otherInput.classList.toggle("d-none", this.value !== "Other");
});

// ===== Career Modal: Toggle Other Input =====
document.getElementById("careerType").addEventListener("change", function () {
  const otherInput = document.getElementById("careerTitleOther");
  otherInput.classList.toggle("d-none", this.value !== "Other");
});

// ===== Event Form: Replace "Other" with custom value =====
document.getElementById("eventForm").addEventListener("submit", function (e) {
  const select = document.getElementById("title");
  const other = document.getElementById("eventTitleOther");
  if (select.value === "Other" && other.value.trim()) {
    select.value = other.value.trim();
  }
});

// ===== Career Form: Replace "Other" with custom value =====
document.getElementById("careerForm").addEventListener("submit", function (e) {
  const select = document.getElementById("careerType");
  const other = document.getElementById("careerTitleOther");
  if (select.value === "Other" && other.value.trim()) {
    select.value = other.value.trim();
  }
});


  function filterFeed() {
    const query = document.getElementById('feedSearch').value.toLowerCase();
    document.querySelectorAll('.feed-card').forEach(card => {
      const text = card.innerText.toLowerCase();
      card.style.display = text.includes(query) ? 'block' : 'none';
    });
  }
  window.filterFeed = filterFeed;
  </script>
</body>
</html>
