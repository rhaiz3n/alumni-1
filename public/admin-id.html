<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ID Request Database | TUP - Cavite</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <link rel="icon" type="image/png" href="/Logo2.png">

  <style>
    body { background:#bebebe; color:#111827; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
    .topbar { background: linear-gradient(175deg, #882323 55%, #000000 60%); }
    .card-surface,
    .card-control {
      background: #fff;
      border: 1px solid #eef2f6;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(16, 24, 40, 0.04);
      width: 100%; /* ✅ always fill column width */
      max-width: 100%; /* ✅ don’t overflow */
    }
    .header-title {
      color: #fff !important;
    }
    .header-subtitle {
      color: #f8f9fa !important; /* softer white (Bootstrap's gray-100) */
    }

    /* Optional: add padding inside */
    .card-surface { padding: 1rem; }
    .card-control { padding: 1rem; }
    .small-muted { color:#64748b; font-size:.88rem; }
    .form-control, .form-select { border-radius:8px; }
    .table thead th {
      border-bottom: 3px solid #000000; /* strong black underline */
      font-size: 15px;
      font-weight: 600;                /* slightly bolder text */
      text-transform: uppercase;       /* optional: makes headers ALL CAPS */
      text-align: center;              /* keeps headers aligned */
      background-color: #f8f9fa;       /* light gray background for contrast */
    }
    /* Loader */
    #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
    .progress-bar-custom { width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin:auto; }
@media print {
  body * {
    visibility: hidden;
  }
  #printTitle, #reqTable, #reqTable * {
    visibility: visible;
  }

  /* Hide VALID ID (7th column) and ACTION (9th column) */
  #reqTable th:nth-child(7),
  #reqTable td:nth-child(7),
  #reqTable th:nth-child(9),
  #reqTable td:nth-child(9) {
    display: none;
  }

  #reqTable {
    position: absolute;
    top: 40px;
    left: 0;
    width: 100%;
  }
}
  </style>
</head>
<body>

  <!-- Topbar -->
  <nav class="topbar py-2">
    <div class="container d-flex align-items-center gap-3">
      <a class="btn btn-outline-light btn-sm" href="admin-homepage.html">
        <i class="fa-solid fa-arrow-left"></i>
      </a>
      <div>
        <div class="fw-bold text-white">
          TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES – CAVITE
        </div>
        <div class="small-muted text-white">
          ID Request Database — Admin
        </div>
      </div>
      <div class="ms-auto">
        <button class="btn btn-primary btn-sm" id="printBtn"><i class="fa-solid fa-print me-1"></i> Print RELEASED Only</button>
      </div>
    </div>
  </nav>

<!-- Main -->
<main class="container-fluid my-4">
  <div class="row g-4 justify-content-start">
    
    <!-- Left: controls -->
    <div class="col-12 col-lg-4">
      <div class="card-control p-3">
        <label class="form-label small-muted mb-1">Search</label>
        <input id="searchInput" class="form-control mb-3" placeholder="Search by name…">

        <label class="form-label small-muted mb-1">Filter by Status</label>
        <select id="statusFilter" class="form-select mb-3">
          <option value="ALL">All Statuses</option>
          <option value="PENDING">Pending</option>
          <option value="ACCEPTED">Accepted</option>
          <option value="DECLINED">Declined</option>
        </select>

        <label class="form-label small-muted mb-1">Page</label>
        <select id="pageSelect" class="form-select mb-3"></select>
      </div>
    </div>

    <!-- Right: table -->
    <div class="col-12 col-lg-8">
      <div class="card-surface p-3">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0" id="reqTable">
            <thead>
              <tr>
                <th>NAME</th>
                <th>DEGREE</th>
                <th>YEAR</th>
                <th>STUDENT NO</th>
                <th>PHONE</th>
                <th>EMAIL</th>
                <th>VALID ID</th>
                <th>STATUS</th>
                <th>ACTION</th>
                <th>SUBMITTED</th>
              </tr>
            </thead>
            <tbody id="reqBody">
              <tr><td colspan="10">Loading…</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- Modal -->
<div class="modal fade" id="idModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Submitted ID</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="idPreview" src="" class="img-fluid rounded" alt="User Submitted ID">
      </div>
    </div>
  </div>
</div>

  <!-- Loader -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div style="text-align:center;">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div style="font-weight:700; letter-spacing:.6px; margin-bottom:8px;">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES — CAVITE</div>
      <div style="width:360px; margin: auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" style="margin-top:10px; color:#6b7280;">0%</div>
    </div>
  </div>

  <script>
    function showToast(message) {
      let toast = document.getElementById("toast");
      if (!toast) {
        toast = document.createElement("div");
        toast.id = "toast";
        toast.style.position = "fixed";
        toast.style.bottom = "30px";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.background = "#333";
        toast.style.color = "#fff";
        toast.style.padding = "12px 20px";
        toast.style.borderRadius = "6px";
        toast.style.zIndex = "10000";
        toast.style.fontSize = "15px";
        toast.style.opacity = "0";
        toast.style.transition = "opacity 0.35s, bottom 0.35s";
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.opacity = "1";
      toast.style.bottom = "50px";
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.bottom = "30px";
      }, 3000);
    }

        /*******************************
   * Loader progress
   *******************************/
  document.addEventListener('DOMContentLoaded', () => {
    let p = 0;
    const bar = document.getElementById('progress-bar');
    const pct = document.getElementById('percentage');
    const wrap = document.getElementById('loader-wrapper');
    const iv = setInterval(() => {
      p = Math.min(100, p + Math.floor(Math.random()*6) + 2);
      bar.style.width = p + '%';
      pct.textContent = p + '%';
      if (p >= 100) {
        clearInterval(iv);
        wrap.style.display = 'none';
      }
    }, 70);
  });


document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('reqBody');
  const searchInput = document.getElementById('searchInput');
  const statusFilter = document.getElementById('statusFilter');
  const pageSelect = document.getElementById('pageSelect');
  const printBtn = document.getElementById('printBtn');

  let requests = [], currentPage = 1, totalPages = 1, LIMIT = 100;

  if (sessionStorage.getItem('userRole') !== 'admin') {
    return window.location.href = 'homepage.html';
  }

  async function loadPage() {
    const search = encodeURIComponent(searchInput.value.trim());
    const url = `/api/requests/list?page=${currentPage}&limit=${LIMIT}${search ? `&search=${search}` : ''}`;
    const res = await fetch(url);
    const data = await res.json();
    requests = data.requests || [];
    totalPages = data.totalPages || 1;
    buildPagination();
    renderTable();
  }

  function buildPagination() {
    pageSelect.innerHTML = '';
    for (let i=1;i<=totalPages;i++){
      const opt = document.createElement('option');
      opt.value = i;
      opt.textContent = `Page ${i}`;
      if(i===currentPage) opt.selected = true;
      pageSelect.appendChild(opt);
    }
  }

function renderTable() {
  const filter = statusFilter.value || 'ALL';
  tbody.innerHTML = '';

  requests
    .filter(r => filter === 'ALL' || (r.status || 'PENDING').toUpperCase() === filter)
    .forEach(r => {
      const status = (r.status || 'PENDING').toUpperCase();
      const tr = document.createElement('tr');

      // ✅ Row background based on status
      if (status.includes("PENDING")) tr.classList.add("table-warning"); 
      if (status === "RELEASING") tr.classList.add("table-info"); 
      if (status === "RELEASED") tr.classList.add("table-success"); 
      if (status === "DECLINED") tr.classList.add("table-danger"); 

      tr.innerHTML = `
        <td>${r.fullName}</td>
        <td>${r.degree}</td>
        <td>${r.yearGraduated}</td>
        <td>${r.studentNo}</td>
        <td>${r.phoneNo}</td>
        <td>${r.email}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary btn-view" 
                  data-url="${r.validIdUrl || ''}">View</button>
        </td>
        <td class="status">${status}</td>
        <td>
          <select class="form-select form-select-sm status-dropdown" data-id="${r.id}">
            <option ${status==="PENDING" ? "selected":""}>PENDING</option>
            <option ${status==="ACCEPTED - PENDING" ? "selected":""}>ACCEPTED - PENDING</option>
            <option ${status==="RELEASING" ? "selected":""}>RELEASING</option>
            <option ${status==="RELEASED" ? "selected":""}>RELEASED</option>
            <option ${status==="DECLINED" ? "selected":""}>DECLINED</option>
          </select>
        </td>
        <td>${r.submittedAt ? new Date(r.submittedAt).toLocaleDateString() : 'N/A'}</td>
      `;

      // ✅ Dropdown change event
      tr.querySelector(".status-dropdown").addEventListener("change", async (e) => {
        const newStatus = e.target.value;
        await updateStatus(r.id, newStatus);
        r.status = newStatus;
        renderTable(); // refresh row colors instantly
      });

      // ✅ View button
      const viewBtn = tr.querySelector(".btn-view");
      if (viewBtn) {
        viewBtn.addEventListener("click", () => {
          // Try multiple possible keys from backend
          const url = r.validIdUrl || r.validId || r.idUrl || "";
          
          if (url) {
            document.getElementById("idPreview").src = url;
            new bootstrap.Modal(document.getElementById("idModal")).show();
          } else {
            showToast("⚠️ No ID uploaded by this user.");
          }
        });
      }

      tbody.appendChild(tr);
    });
}


// ✅ Helper function to update status
async function updateStatus(id, newStatus) {
  try {
    const res = await fetch(`/api/requests/${id}/status`, {
      method: "PATCH", // ✅ use PATCH, not PUT
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ status: newStatus })
    });

    if (!res.ok) throw new Error("Failed to update request");

    // Refresh list
    await loadPage();
  } catch (err) {
    console.error("❌ Error updating status:", err);
    showToast("Failed to update request");
  }
}

  // Print accepted only
  printBtn.addEventListener('click', ()=>{
    document.querySelectorAll('#reqBody tr').forEach(row=>{
      const status = row.querySelector('.status')?.innerText.trim();
      row.style.display = status==='RELEASED'?'':'none';
    });
    setTimeout(()=>window.print(),100);
    setTimeout(()=>document.querySelectorAll('#reqBody tr').forEach(row=>row.style.display=''),500);
  });

  pageSelect.addEventListener('change',()=>{currentPage=+pageSelect.value; loadPage();});
  searchInput.addEventListener('input',()=>{currentPage=1; loadPage();});
  statusFilter.addEventListener('change', renderTable);

  loadPage();
});

// --- Initialize everything on DOM load ---
document.addEventListener('DOMContentLoaded', () => {
  if (sessionStorage.getItem('userRole') !== 'admin') {
    showToast("⛔ Access denied. Admins only!");
    window.location.href = 'homepage.html';
  }
});
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
