<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Employer Dashboard | TUP - Cavite</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts (kept) -->
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;500;700&family=Albert+Sans:wght@400;500;700&family=Sanchez&display=swap" rel="stylesheet" />

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <link rel="icon" type="image/png" href="/Logo2.png">


  <style>
    /* Minimal overrides to make Bootstrap layout fit your existing class hooks */
    body { font-family: "Albert Sans", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: #bebebe; }
    .navbar-brand img { height: 40px; }
    .profile-circle-employer { cursor: pointer; }
    .profile-pic-employer {
      border: 4px solid rgb(199, 199, 199); /* custom color */
    }
    .card-rounded { border-radius: .75rem; }
.feed-card {
  padding: 1rem;
  border-radius: .75rem;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
}

.feed-img {
  width: 100%;
  height: 220px;        /* keep consistent size */
  object-fit: cover;    /* nicely cropped */
  border-radius: .5rem;
  margin-bottom: .75rem;
}

.feed-header {
  display: flex;
  align-items: center;
  margin-bottom: .75rem;
}

.feed-header img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  margin-right: .75rem;
}

.feed-meta {
  font-size: 0.85rem;
  color: #6c757d;
}

.feed-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: .75rem;
}

    .countdown { font-weight: 600; color: #333; }
    .applications-container table td, .applications-container table th { vertical-align: middle; }
    /* preserve some of your classes if your CSS depends on them */
    .modal-profile-employer, .modal-applications-employer { display: none; }
    /* small responsive tweak so left column stays visible and content centers */
    @media (max-width: 991px) {
      .col-lg-3 { margin-bottom: 1rem; }
    }
        /* Loader overlay */
    #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
    .progress-bar-custom { left: 100px; width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin: auto;}
  </style>
</head>
<body>

      <!-- Loader (Bootstrap replacement) -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div style="text-align:center;">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div style="font-weight:700; letter-spacing:.6px; margin-bottom:8px;">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES ‚Äî CAVITE</div>
      <div style="width:360px; margin: auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" style="margin-top:10px; color:#6b7280;">0%</div>
    </div>
  </div>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top" style="background: linear-gradient(175deg, #882323 55%, #000000 60%);">
    <div class="container-fluid px-4">
      <a class="navbar-brand d-flex align-items-center" href="employer-page.html">
        <img src="Logo.png" alt="Logo">
        <span class="d-block d-md-inline ms-2 fw-bold text-white text-wrap text-truncate" style="max-width: 100%;">
          Technological University of the Philippines - Cavite Campus - Employer
        </span>
      </a>

      <div class="ms-auto d-flex align-items-center gap-3">
        <span id="employerNameDisplay" class="d-none d-md-inline fw-semibold text-white"></span>


        <!-- small circle employer logo trigger (kept id/class) -->
        <img id="employerLogo"
             src="/images/default-company.png"
             alt="Company Logo"
             class="profile-circle-employer rounded-circle border"
             width="44" height="44"
             onclick="openEmployerProfileModal()">

        <!-- sign out button kept with ID -->
        <button id="signOutBtn" class="btn btn-outline-danger btn-sm">SIGN-OUT</button>
      </div>
    </div>
  </nav>

  <!-- MAIN LAYOUT (3 columns) -->
  <main class="container-fluid" style="margin-top: 90px;">
    <div class="row justify-content-center gx-4">

      <!-- LEFT: Employer Profile -->
      <aside class="col-lg-3">
          <div class="card card-rounded shadow-sm mb-4" 
       style="position: sticky; top: 90px; z-index: 100;">
          <div class="card-body text-center">
         <img id="sidebarEmployerLogo" 
          src="/images/default-company.png" 
          class="profile-pic-employer rounded-circle" 
          style="width:120px;height:120px;">    

            <div class="d-grid gap-2 mt-3">
              <button id="viewApplicantsBtn" class="btn btn-outline-primary btn-sm">VIEW APPLICANTS</button>
              <button id="changeLogoBtn" class="btn btn-outline-secondary btn-sm">Change Profile Picture</button>
              <input type="file" id="uploadCompanyLogo" name="companyLogo" style="display:none" />
              <button id="editEmployerBtn" class="btn btn-primary">Edit</button>
              <button id="saveEmployerBtn" class="btn btn-success d-none">Save</button>
              <button id="closeEmployerBtn" class="btn btn-secondary d-none">Close</button>
              <button id="confirmEmployerProfileBtn" class="btn btn-success btn-sm mt-2" style="display:none;">‚úÖ Confirm Profile</button>
              <div id="employerProfileNotice" class="alert alert-warning mt-2" style="display:none;">‚ö†Ô∏è Please upload your company logo to continue.</div>
            </div>

            

            <div id="employerProfileNotice" class="alert alert-warning mt-3 d-none profile-notice-employer" role="alert"></div>
          </div>

          <ul class="list-group list-group-flush">
            <li class="list-group-item"><strong>Business Name:</strong> <span id="businessName">-</span></li>
            <li class="list-group-item"><strong>Address:</strong> <span id="businessAddress">-</span></li>
            <li class="list-group-item"><strong>Landline:</strong> <span id="landlineNo">-</span><input id="editLandlineNo" class="form-control mt-1 d-none" style="max-width:250px;"></li>
            <li class="list-group-item"><strong>Mobile:</strong> <span id="mobileNo">-</span><input id="editMobileNo" class="form-control mt-1 d-none" style="max-width:250px;"></li>
            <li class="list-group-item"><strong>Email:</strong> <span id="companyEmail">-</span><input id="editCompanyEmail" class="form-control mt-1 d-none" style="max-width:250px;"></li>
            <li class="list-group-item"><strong>Website:</strong> <span id="companyWebsite">-</span></li>
          </ul>
        </div>
      </aside>

      <!-- CENTER: Feed -->
      <section class="col-lg-6">
        <!-- Post button and controls -->
        <div class="d-flex justify-content-end mb-3">
          <button id="openModalBtn" class="btn btn-primary galaxy-btn"><i class="fa-solid fa-plus me-1"></i> POST NEW CAREER</button>
        </div>

        <!-- FEED container (kept id feed) -->
        <div id="feed">
          <!-- feed content will be inserted by JS (loadFeed) - cards styled by Bootstrap in JS portion -->
        </div>
      </section>

    </div>
  </main>

  <!-- ============================
       Create Career Modal (kept IDs/classes)
       Implemented as a simple centered element (not Bootstrap modal) to keep your original JS display logic intact.
       If you prefer Bootstrap modal behavior, we can switch, but this preserves your existing handlers.
  ============================= -->
  <div id="eventModal" class="modal" tabindex="-1" style="display:none; position:fixed; inset:0; z-index:1050; background:rgba(0,0,0,0.45); align-items:center; justify-content:center;">
    <div class="modal-content galaxy-card card-rounded p-4" role="dialog" style="max-width:720px;">
      <button class="btn-close position-absolute" style="right: 20px; top: 20px;" id="closeModalBtn" aria-label="Close"></button>
      <h4>Create Career</h4>
      <form id="adminForm" enctype="multipart/form-data" class="mt-3">
        <div class="mb-2">
        <label class="form-label">Career Type</label>
        <select id="careerType" name="careerType" required class="form-select">
          <option value="">-- Select a Career --</option>
          <option value="Electrician">Electrician</option>
          <option value="Mechanic">Mechanic</option>
          <option value="Education">Education</option>
          <option value="Software Developer">Software Developer</option>
          <option value="Network Engineer">Network Engineer</option>
          <option value="Telecommunications Engineer">Telecommunications Engineer</option>
          <option value="Electrical Engineer">Electrical Engineer</option>
          <option value="Maintenance Engineer / Technician">Maintenance Engineer / Technician</option>
          <option value="Other">Other</option>
        </select>

        <input type="hidden" id="careerTitle" name="title">
        <input type="text" id="otherCareerInput" class="form-control mt-2" placeholder="Enter Career Type" style="display:none;">
      </div>

        <div class="mb-2">
          <label class="form-label">Company Name</label>
          <input type="text" name="link" class="form-control" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Image</label>
          <input type="file" name="image" accept=".png,.jpg" class="form-control" required>
        </div>

        <div class="mb-3">
          <label class="form-label">Description</label>
          <textarea name="description" rows="3" class="form-control" required></textarea>
        </div>

        <div class="text-end">
          <button type="submit" class="btn btn-success galaxy-btn2">Publish</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Applications modal (used inside employer profile, kept) -->
  <div id="applicantsModal" class="modal-applications-employer" aria-hidden="true" style="display:none; position:fixed; inset:0; z-index:1060; background:rgba(0,0,0,0.45); align-items:center; justify-content:center;">
    <div class="modal-app-content-employer card p-3" style="max-width:900px;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">APPLICANTS</h5>
        <button class="btn-close" onclick="closeApplicantsModal()"></button>
      </div>
      <div class="table-responsive applications-container">
        <table class="table table-striped applications-table-employer mb-0">
          <thead>
            <tr><th>NAME</th><th>PHONE NO.</th><th>EMAIL</th><th>RESUME</th><th>SUBMITTED AT</th></tr>
          </thead>
          <tbody id="applicantsTableBody">
            <tr><td colspan="5">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Application viewer modal (for center feed expand) -->
  <div id="modal-application" class="modal-application" style="display:none; position:fixed; inset:0; z-index:1060; background:rgba(0,0,0,0.45); align-items:center; justify-content:center;">
    <div class="modal-content-application card p-3" style="max-width:720px;">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">üìÑ Applications</h5>
        <button class="btn-close" onclick="document.getElementById('modal-application').style.display='none'"></button>
      </div>
      <div id="applications-container"></div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Include sign-out module (kept) -->
  <script type="module">
    import { setupSignOut } from './sign-out.js';
    setupSignOut('employer'); // üîí restrict to employer only
  </script>

  <script>
    // --- Dropdown helper kept (no changes) ---
    function toggleDropdown() {
      document.getElementById('dropdownMenu')?.classList.toggle('show');
    }

    function navigateTo(url) {
      window.location.href = url;
    }

    window.addEventListener('click', e => {
      const trigger = document.querySelector('.select-trigger');
      const menu = document.getElementById('dropdownMenu');
      if (!trigger?.contains(e.target) && !menu?.contains(e.target)) {
        menu?.classList.remove('show');
      }
    });

    // Access control (kept)
    window.addEventListener('DOMContentLoaded', () => {
      const role = sessionStorage.getItem('userRole');
      if (role !== 'employer') {
        // If not employer, redirect to homepage (kept behavior)
        window.location.href = 'homepage.html';
      }
    });

    // Toast function (kept)
    function showToast(message) {
      let toast = document.getElementById("toast");
      if (!toast) {
        toast = document.createElement("div");
        toast.id = "toast";
        toast.style.position = "fixed";
        toast.style.bottom = "30px";
        toast.style.left = "50%";
        toast.style.transform = "translateX(-50%)";
        toast.style.background = "#333";
        toast.style.color = "#fff";
        toast.style.padding = "12px 20px";
        toast.style.borderRadius = "6px";
        toast.style.zIndex = "10000";
        toast.style.fontSize = "15px";
        toast.style.opacity = "0";
        toast.style.transition = "opacity 0.35s, bottom 0.35s";
        document.body.appendChild(toast);
      }
      toast.textContent = message;
      toast.style.opacity = "1";
      toast.style.bottom = "50px";
      setTimeout(() => {
        toast.style.opacity = "0";
        toast.style.bottom = "30px";
      }, 3000);
    }

    // Modal references
    const modal = document.getElementById('eventModal');
    const editModal = document.getElementById('editModal'); // may be undefined if not present ‚Äî original code had this too

    /* ---------------------------
       Load Employer Profile
    ---------------------------- */
async function loadEmployerProfile() {
  const logo = document.getElementById("employerLogo");

  try {
    const res = await fetch("/api/employers/me", {
      credentials: "include",
      cache: "no-store"
    });
    if (!res.ok) throw new Error("Not logged in");

    const employer = await res.json();

    // Fill details
    document.getElementById("businessName").textContent = employer.businessName || "NA";
    document.getElementById("businessAddress").textContent = employer.businessAddress || "NA";
    document.getElementById("landlineNo").textContent = employer.landlineNo || "NA";
    document.getElementById("mobileNo").textContent = employer.mobileNo || "NA";
    document.getElementById("companyEmail").textContent = employer.companyEmail || "NA";
    document.getElementById("companyWebsite").textContent = employer.companyWebsite || "NA";

    // ‚úÖ Logo
    logo.src = employer.companyLogo || "/images/default-company.png";

    // ‚úÖ Post button (disabled until confirmed)
    const postBtn = document.getElementById("openModalBtn");
    if (employer.profileConfirmed === 1) {
      postBtn.disabled = false;
      postBtn.classList.remove("btn-secondary");
      postBtn.classList.add("btn-primary");
    } else {
      postBtn.disabled = true;
      postBtn.classList.remove("btn-primary");
      postBtn.classList.add("btn-secondary");
    }

    // ‚úÖ Confirm button logic
    const confirmBtn = document.getElementById("confirmProfileBtn");
    const notice = document.getElementById("employerProfileNotice");

    if (employer.profileConfirmed === 1) {
      document.getElementById("confirmEmployerProfileBtn").style.display = "none";
      document.getElementById("employerProfileNotice").style.display = "none";

      // enable post button
      const postBtn = document.getElementById("openModalBtn");
      postBtn.disabled = false;
      postBtn.classList.remove("btn-secondary");
      postBtn.classList.add("btn-primary");
    } else {
      const confirmBtn = document.getElementById("confirmEmployerProfileBtn");
      const notice = document.getElementById("employerProfileNotice");

      if (employer.companyLogo && !employer.companyLogo.includes("default-company.png")) {
        // logo uploaded but not confirmed yet
        confirmBtn.style.display = "block";
        notice.style.display = "block";
        notice.textContent = "‚ö†Ô∏è Click Confirm to activate your account.";
      } else {
        // still missing logo
        confirmBtn.style.display = "none";
        notice.style.display = "block";
        notice.textContent = "‚ö†Ô∏è Please upload your company logo to continue.";
      }
    }


  } catch (err) {
    console.error("‚ùå Error loading employer info:", err);
    logo.src = "/images/default-company.png";
  }
}

    /* ---------------------------
       Modal Open / Close for Employer Profile
    ---------------------------- */
    function openEmployerProfileModal() {
      const modalProfile = document.getElementById("modal-employer-profile");
      if (!modalProfile) return;
      modalProfile.style.display = "flex";
      modalProfile.setAttribute("aria-hidden", "false");
      document.getElementById("employerName").textContent = "Loading...";
      loadEmployerProfile(true);
    }

    function closeEmployerProfileModal() {
      const modalProfile = document.getElementById("modal-employer-profile");
      // prevent closing if locked
      if (modalProfile && modalProfile.dataset.locked !== "true") {
        modalProfile.style.display = "none";
        modalProfile.setAttribute("aria-hidden", "true");
      }
    }

    /* ---------------------------
       Enable Edit Mode
    ---------------------------- */
function enableEmployerEdit() {
  ["landlineNo", "mobileNo", "companyEmail"].forEach(field => {
    const textEl = document.getElementById(field);
    const inputEl = document.getElementById("edit" + field.charAt(0).toUpperCase() + field.slice(1));

    if (textEl) textEl.classList.add("d-none");   // hide text
    if (inputEl) {
      inputEl.classList.remove("d-none");         // show input
      inputEl.value = textEl.textContent.trim() !== "NA" ? textEl.textContent.trim() : "";

      if (field === "landlineNo" || field === "mobileNo") {
        inputEl.setAttribute("maxlength", "15");

        inputEl.addEventListener("input", () => {
          let val = inputEl.value.toUpperCase();

          // Allow exactly "NA" or "NONE"
          if (val === "NA" || val === "NONE") {
            inputEl.value = val;
            return;
          }

          // Otherwise allow only digits (max 15 already handled by maxlength)
          inputEl.value = val.replace(/[^0-9]/g, "");
        });
      }
    }
  });

  document.getElementById("editEmployerBtn").classList.add("d-none");
  document.getElementById("saveEmployerBtn").classList.remove("d-none");
  document.getElementById("closeEmployerBtn").classList.remove("d-none");
}


function exitEditMode() {
  ["landlineNo", "mobileNo", "companyEmail"].forEach(field => {
    const textEl = document.getElementById(field);
    const inputEl = document.getElementById("edit" + field.charAt(0).toUpperCase() + field.slice(1));

    if (textEl) textEl.classList.remove("d-none"); // show text again
    if (inputEl) {
      inputEl.classList.add("d-none");             // hide input
      inputEl.value = "";                          // clear input
    }
  });

  document.getElementById("editEmployerBtn").classList.remove("d-none");
  document.getElementById("saveEmployerBtn").classList.add("d-none");
  document.getElementById("closeEmployerBtn").classList.add("d-none");
}

async function saveEmployerProfile() {
  const landline = document.getElementById("editLandlineNo").value.trim();
  const mobile = document.getElementById("editMobileNo").value.trim();
  const email = document.getElementById("editCompanyEmail").value.trim();

  const updatedData = {};
  if (landline) updatedData.landlineNo = landline;
  if (mobile) updatedData.mobileNo = mobile;
  if (email) updatedData.companyEmail = email;

  if (Object.keys(updatedData).length === 0) {
    showToast("‚ö†Ô∏è No changes to save, closing edit mode.");
    exitEditMode();
    return;
  }

  try {
    const res = await fetch("/api/employers/update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(updatedData),
    });

    const data = await res.json();
    if (data.success) {
      showToast("‚úÖ Changes submitted for admin approval");
      exitEditMode();
    } else {
      showToast("‚ùå Error: " + data.error);
    }
  } catch (err) {
    console.error("‚ùå Update error:", err);
    showToast("Server error while updating");
  }
}
    /* ---------------------------
       Save Employer Profile
    ---------------------------- */

    /* ---------------------------
       Upload Company Logo
    ---------------------------- */
// const fileInput = document.getElementById("uploadCompanyLogo");
// fileInput.onchange = async () => {
//   const file = fileInput.files[0];
//   if (!file) return;

//   const formData = new FormData();
//   formData.append("logo", file); // must match backend's upload.single("logo")

//   try {
//     const res = await fetch("/api/employers/upload-logo", { // <-- plural 'employers'
//       method: "POST",
//       body: formData
//     });

//     const data = await res.json();

//     if (!res.ok) {
//       showToast(`‚ùå Upload failed: ${JSON.stringify(data)}`);
//       return;
//     }

//     // update images
//     const sidebarLogo = document.getElementById("sidebarEmployerLogo");
//     const navbarLogo = document.getElementById("employerLogo");
//     if (sidebarLogo) sidebarLogo.src = data.logoPath;
//     if (navbarLogo) navbarLogo.src = data.logoPath;

//     showToast("‚úÖ Logo uploaded!");
//     checkEmployerProfilePic(); // re-enable POST NEW CAREER button if needed
//   } catch (err) {
//     console.error("‚ùå Upload failed:", err);
//     showToast("‚ùå Upload failed: " + err.message);
//   }
// };

    /* ---------------------------
       Confirm Employer Profile
    ---------------------------- */
document.getElementById("confirmEmployerProfileBtn")?.addEventListener("click", async () => {
  try {
    const res = await fetch("/api/employers/confirm", {
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
    });
    const data = await res.json();

    if (res.ok && data.success) {
      showToast("‚úÖ Profile confirmed!");

      // Enable Post button
      const postBtn = document.getElementById("openModalBtn");
      postBtn.disabled = false;
      postBtn.classList.remove("btn-secondary");
      postBtn.classList.add("btn-primary");

      // Hide notice
      const notice = document.getElementById("employerProfileNotice");
      if (notice) notice.style.display = "none";

      // Hide confirm button
      document.getElementById("confirmEmployerProfileBtn").style.display = "none";
    } else {
      showToast(data.error || "Please upload a logo first.");
    }
  } catch (err) {
    console.error("‚ùå Confirm error:", err);
    showToast("Server error while confirming");
  }
});

    /* ---------------------------
       Applicants Modal (employer-side)
    ---------------------------- */
    async function openApplicantsModal() {
      const modal = document.getElementById("applicantsModal");
      modal.style.display = "flex";

      const tbody = document.getElementById("applicantsTableBody");
      tbody.innerHTML = `<tr><td colspan="5">‚è≥ Loading...</td></tr>`;

      try {
        const res = await fetch("/api/applications/employer", { credentials: "include" });
        if (!res.ok) throw new Error("Failed to fetch applicants");

        const applicants = await res.json();
        tbody.innerHTML = applicants.length
          ? applicants.map(app => `
            <tr>
              <td>${(app.firstName || "").toUpperCase()} ${(app.lastName || "").toUpperCase()}</td>
              <td>${app.phoneNo || "-"}</td>
              <td>${app.email || "-"}</td>
              <td><a href="/uploads/resumes/${app.resumePath}" target="_blank">VIEW</a></td>
              <td>${app.dateSubmitted ? new Date(app.dateSubmitted).toLocaleString() : "-"}</td>
            </tr>
          `).join("")
          : `<tr><td colspan="5">No applications found</td></tr>`;
      } catch (err) {
        console.error("‚ùå Error loading applicants:", err);
        tbody.innerHTML = `<tr><td colspan="5">‚ö†Ô∏è Failed to load applicants</td></tr>`;
      }
    }

    function closeApplicantsModal() {
      const modal = document.getElementById("applicantsModal");
      if (modal) modal.style.display = "none";
    }


/* ---------------------------
   Event Bindings on DOMContentLoaded
---------------------------- */
document.addEventListener("DOMContentLoaded", () => {;
  const editModal = document.getElementById('editModal');

  // Profile modal open
  document.getElementById("employerLogo")?.addEventListener("click", openEmployerProfileModal);

  // Open applicants modal button
  document.getElementById("viewApplicantsBtn")?.addEventListener("click", openApplicantsModal);

  // Close when clicking outside certain modals
  document.getElementById("modal-employer-profile")?.addEventListener("click", e => {
    if (e.target.id === "modal-employer-profile") closeEmployerProfileModal();
  });
  document.getElementById("applicantsModal")?.addEventListener("click", e => {
    if (e.target.id === "applicantsModal") closeApplicantsModal();
  });

  // Change logo trigger
  document.getElementById("changeLogoBtn")?.addEventListener("click", () =>
    document.getElementById("uploadCompanyLogo").click()
  );

  // Edit/save profile
  document.getElementById("editEmployerBtn")?.addEventListener("click", enableEmployerEdit);
  document.getElementById("saveEmployerBtn")?.addEventListener("click", saveEmployerProfile);
  document.getElementById("closeEmployerBtn")?.addEventListener("click", () => {
    showToast("‚ùå Edit cancelled");
    exitEditMode();
  });

  // ---------------------------
  // Upload company logo
  // ---------------------------
 // upload when file selected
document.getElementById("uploadCompanyLogo").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  const formData = new FormData();
  formData.append("companyLogo", file);

  try {
    const res = await fetch("/api/employers/upload-logo", {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if (!res.ok || !data.success) {
      showToast(`‚ùå Upload failed: ${JSON.stringify(data)}`);
      return;
    }

    // update UI logos
    document.getElementById("sidebarEmployerLogo").src = data.logoUrl;
    document.getElementById("employerLogo").src = data.logoUrl;

    showToast("‚úÖ Logo uploaded successfully!");

    // üî• refresh employer state without reloading the page
    loadEmployerProfile();
    
  } catch (err) {
    console.error(err);
    showToast("‚ùå Upload failed: Server error");
  }
});

  // ---------------------------
  // POST NEW CAREER button
  // ---------------------------
// ‚ö° Correct modal reference
const modal = document.getElementById('eventModal');
const form = document.getElementById('adminForm');
const careerSelect = document.getElementById('careerType');
const otherCareerInput = document.getElementById('otherCareerInput');

// -----------------------------
// Open modal button
// -----------------------------
document.getElementById('openModalBtn').onclick = async () => {
  const role = sessionStorage.getItem("userRole");

  // 1Ô∏è‚É£ Load employer profile to check logo
  let employerLogo = '/images/default-company.png';
  try {
    const resProfile = await fetch(`/api/employers/me`, { credentials: 'include' });
    if (resProfile.ok) {
      const data = await resProfile.json();
      employerLogo = data.companyLogo || '/images/default-company.png';
    } else {
      console.warn("Failed to load employer profile:", resProfile.status);
    }
  } catch (err) {
    console.warn("Could not load employer profile:", err);
  }

  if (employerLogo === '/images/default-company.png') {
    showToast("‚ö†Ô∏è You need to upload a profile picture to access this posting");
    return;
  }

  // 2Ô∏è‚É£ Check last post time
  if (role === 'employer') {
    try {
      const userId = sessionStorage.getItem("userId");
      const res = await fetch(`/api/careers/last-post/${userId}`);
      if (res.ok) {
        const data = await res.json();
        if (data.lastPost) {
          const lastPostTime = new Date(data.lastPost);
          const now = new Date();
          const diffMs = now - lastPostTime;
          if (diffMs < 24 * 60 * 60 * 1000) {
            const remainingMs = 24 * 60 * 60 * 1000 - diffMs;
            const hours = Math.floor(remainingMs / (1000 * 60 * 60));
            const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
            showToast(`‚ö†Ô∏è You can only post 1 career per day. Try again in ${hours}h ${minutes}m ${seconds}s`);
            return;
          }
        }
      }
    } catch (err) {
      console.warn("Could not check last post:", err);
    }
  }

  // 3Ô∏è‚É£ Open modal
  modal.style.display = 'flex';
};

// -----------------------------
// Close modal
// -----------------------------
document.getElementById('closeModalBtn').onclick = () => {
  modal.style.display = 'none';
};

// Close on outside click
window.onclick = e => {
  if (e.target === modal) modal.style.display = 'none';
};

// -----------------------------
// Career type validation logic
// -----------------------------
careerSelect.addEventListener("change", () => {
  if (careerSelect.value === "Other") {
    otherCareerInput.style.display = "block";
    otherCareerInput.removeAttribute("disabled");
    otherCareerInput.setAttribute("required", "true");
  } else {
    otherCareerInput.style.display = "none";
    otherCareerInput.setAttribute("disabled", "true");
    otherCareerInput.removeAttribute("required");
    otherCareerInput.value = "";
  }
});

// -----------------------------
// Submit handler (attach only once)
// -----------------------------
if (!form.dataset.listenerAttached) {
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    console.log("Submitting career form..."); // debug check

    if (!form.checkValidity()) {
      form.classList.add("was-validated");
      return;
    }

    const formData = new FormData(form);

    // Override only if "Other" was selected
    if (careerSelect.value === "Other" && otherCareerInput.value.trim()) {
      formData.set("title", otherCareerInput.value.trim());
    } else {
      formData.set("title", careerSelect.value);
    }

    try {
      const res = await fetch("/api/careers/add", { method: "POST", body: formData });
      if (!res.ok) throw new Error("Failed to post career");

      // Close modal
      modal.style.display = "none";

      // Reset form
      form.reset();
      form.classList.remove("was-validated");
      otherCareerInput.style.display = "none";
      otherCareerInput.setAttribute("disabled", "true");

      loadFeed(); // reload feed
    } catch (err) {
      console.error("‚ùå Career submission error:", err);
    }
  });

  // Mark listener as attached ‚úÖ
  form.dataset.listenerAttached = "true";
}

  // ---------------------------
  // Initial loads
  // ---------------------------
  loadEmployerProfile();
  loadFeed();
});



    /* ---------------------------
       FEED: loadFeed & toggleApplications
       (kept logic, but styled to Bootstrap cards)
    ---------------------------- */
    async function loadFeed() {
      const container = document.getElementById('feed');
      container.innerHTML = '<div class="text-center text-muted py-4">Loading your posted careers...</div>';

      try {
        const res = await fetch('/api/careers');
        if (!res.ok) throw new Error('Failed to fetch careers');

        const payload = await res.json();
        const careers = payload.careers || [];

        if (!careers.length) {
          container.innerHTML = '<div class="text-center text-muted py-4">üì≠ You haven‚Äôt posted any careers yet.</div>';
          return;
        }

container.innerHTML = careers
  .sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted))
  .map((post, idx) => `
    <div class="feed-card card shadow-sm border-0 rounded-3 mb-4" id="career-${post.id}">
      <!-- Header -->
      <div class="feed-header d-flex justify-content-between align-items-start mb-2">
        <div class="d-flex align-items-center">
        <img src="Logo2.png" 
            alt="Logo2" 
            class="rounded-circle me-2" 
            style="width:40px; height:40px; object-fit:cover; border: 2px solid #bdbdbd;">
          <div>
            <div class="fw-bold">TUP Cavite Alumni Association</div>
            <small class="text-muted">
              ${new Date(post.datePosted).toLocaleString()}
            </small>
          </div>
        </div>
        <span class="badge bg-${post.isClosed ? "danger" : "success"}">
          ${post.isClosed ? "CLOSED" : "ACTIVE"}
        </span>
      </div>

      <img src="${post.image}" 
          class="card-img-top img-fluid"
          alt="Career image"
          style="width: 100%; height: 350px; object-fit: cover; border-radius: 0.5rem; border: 3px solid #ccc;"
          onerror="this.style.display='none'">

      <!-- Content -->
      <div class="fw-bold mt-2" style="text-align:justify; word-break:break-word; white-space:pre-line;">
        ${(post.title || '').toUpperCase()}
      </div>
      <p class="mb-1" style="text-align:justify; word-break:break-word; white-space:pre-line;">
        ${post.description || ''}
      </p>
      <div class="text-muted small" style="text-align:justify; word-break:break-word; white-space:pre-line;">
        üè¢ ${post.link || "N/A"}
      </div>

      <!-- Footer -->
      <div class="d-flex justify-content-between align-items-center mt-2">
        <span class="countdown text-muted small" data-time="${post.datePosted}" id="countdown-${idx}"></span>
        <button onclick="toggleApplications(${post.id})" class="btn btn-sm btn-outline-primary">
          üìÑ View Applications
        </button>
      </div>

      <!-- Applications section -->
      <div id="applications-${post.id}" class="applications-container mt-3" style="display:none;"></div>
    </div>
  `).join('');




        // countdown updater
        function updateCountdowns() {
          document.querySelectorAll(".countdown").forEach(el => {
            const postedTime = new Date(el.dataset.time);
            const expireTime = new Date(postedTime.getTime() + 5 * 24 * 60 * 60 * 1000);
            const now = new Date();
            const diffMs = expireTime - now;

            const card = el.closest(".feed-card");

            if (diffMs <= 0) {
              el.textContent = "‚ùå Closed";
              if (card) card.classList.add("expired");
              return;
            }

            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);

            el.textContent = days > 0
              ? `${days}d ${hours}h ${minutes}m ${seconds}s left`
              : `${hours}h ${minutes}m ${seconds}s left`;
          });
        }

        updateCountdowns();
        // clear any previous interval if necessary by wrapping in closure ‚Äî simple approach:
        if (window.__countdownInterval) clearInterval(window.__countdownInterval);
        window.__countdownInterval = setInterval(updateCountdowns, 1000);

      } catch (err) {
        console.error(err);
        container.innerHTML = '<div class="text-center text-danger py-4">‚ö†Ô∏è Failed to load your careers.</div>';
      }
    }

    // toggleApplications: show/hide and fetch applications for specific career
    async function toggleApplications(careerId) {
      const container = document.getElementById(`applications-${careerId}`);
      if (!container) return;

      if (container.style.display === "block") {
        container.style.display = "none";
        container.innerHTML = '';
        return;
      }

      container.style.display = "block";
      container.innerHTML = `<div class="text-muted">‚è≥ Loading applications...</div>`;

      try {
        const res = await fetch(`/api/applications/career/${careerId}`);
        if (!res.ok) throw new Error("Failed to fetch applications");

        const apps = await res.json();
        if (!apps.length) {
          container.innerHTML = '<div class="text-muted">‚ö†Ô∏è No applications yet.</div>';
          return;
        }

        container.innerHTML = `
          <div class="table-responsive">
            <table class="table table-bordered mb-0">
              <thead class="table-light"><tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Phone</th><th>Resume</th></tr></thead>
              <tbody>
                ${apps.map(app => `
                  <tr>
                    <td>${(app.firstName||'').toUpperCase()}</td>
                    <td>${(app.lastName||'').toUpperCase()}</td>
                    <td>${app.email || '-'}</td>
                    <td>${app.phoneNo || '-'}</td>
                    <td><a href="/uploads/resumes/${app.resumePath}" target="_blank">VIEW</a></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        `;
      } catch (err) {
        console.error("‚ùå Failed to load applications:", err);
        container.innerHTML = "<div class='text-danger'>‚ö†Ô∏è Failed to load applications.</div>";
      }
    }

    // Fetch basic employer display name for navbar
    fetch('/api/employer/me')
      .then(res => res.json())
      .then(user => {
        const nameEl = document.getElementById("employerNameDisplay");
        if (!nameEl) return;
        if (user && user.role === "employer" && user.employerName) {
          nameEl.textContent = user.employerName.toUpperCase();
          nameEl.classList.remove('d-none');
        } else {
          nameEl.textContent = "GUEST";
          nameEl.classList.remove('d-none');
        }
      })
      .catch(() => {
        // ignore errors, keep element hidden or show GUEST
      });


      // Fetch the employer logo and update the image
async function loadEmployerLogo() {
  try {
    const res = await fetch("/api/employers/get-logo"); // correct route
    const data = await res.json();

    if (data.companyLogo) {
      // Update both modal and sidebar
      document.getElementById("sidebarEmployerLogo").src = data.companyLogo;
    }
  } catch (err) {
    console.error("‚ùå Could not load employer logo:", err);
  }
}

window.addEventListener("DOMContentLoaded", loadEmployerLogo);



  /*******************************
   * Loader progress
   *******************************/
  document.addEventListener('DOMContentLoaded', () => {
    let p = 0;
    const bar = document.getElementById('progress-bar');
    const pct = document.getElementById('percentage');
    const wrap = document.getElementById('loader-wrapper');
    const iv = setInterval(() => {
      p = Math.min(100, p + Math.floor(Math.random()*6) + 2);
      bar.style.width = p + '%';
      pct.textContent = p + '%';
      if (p >= 100) {
        clearInterval(iv);
        wrap.style.display = 'none';
      }
    }, 70);
  });
</script>
</body>
</html>
