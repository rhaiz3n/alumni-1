<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TUPC Alumni — Modern Feed</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <link rel="icon" type="image/png" href="/Logo2.png">

  <!-- Inline modern styling -->
  <style>
    :root{
      --fb-blue:#1877f2;
      --muted:#6c757d;
      --card-bg: #ffffff;
      --card-radius: 14px;
      --shadow: 0 6px 18px rgba(15,23,42,0.08);
    }
    body{
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: #bebebe;
      color: #111827;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* Top navbar - Facebook-style */
    .topbar {
      background: linear-gradient(90deg, var(--fb-blue) 0%, #135bd8 100%);
      color: white;
      box-shadow: 0 1px 0 rgba(0,0,0,0.06);
      position: sticky;
      top: 0;
      z-index: 1050;
    }
    .topbar .navbar-brand { display:flex; align-items:center; gap:.6rem; }
    .topbar .btn-outline-light { border-color: rgba(255,255,255,0.2); color:white; }
    .topbar .btn-outline-light:hover { background: rgba(255,255,255,0.06); }

    /* Layout */
    .app-container { max-width:1200px; margin: 22px auto; padding: 0 16px; }
    .left-card, .right-card, .feed-card { background: var(--card-bg); border-radius: var(--card-radius); box-shadow: var(--shadow); }

    /* Left sidebar */
    .left-card { padding: 18px; margin-bottom: 18px; position: sticky;  top: 70px; z-index: 1020;}
    .shortcut-btn { border-radius: 10px; background: linear-gradient(180deg,#fff,#f7f9fb); border:1px solid #e6e9ee; padding:12px; text-align:left; display:flex; gap:12px; align-items:center; transition: transform .12s ease, box-shadow .12s ease; }
    .shortcut-btn:hover { transform: translateY(-4px); box-shadow: 0 10px 30px rgba(15,23,42,0.06); }

    /* Feed cards */
    .feed-card { padding: 14px; margin-bottom: 16px; }
    .feed-header { display:flex; gap:12px; align-items:center; }
    .avatar { width:50px; height:44px; border-radius:50%; object-fit:cover; border: 3px solid #c9c9c9; box-shadow:0 2px 8px rgba(15,23,42,0.06); }
    .avatar1 { width:50px; height:50px; border-radius:50%; object-fit:cover; border: 3px solid #c9c9c9; box-shadow:0 2px 8px rgba(15,23,42,0.06); }
    .feed-title { font-weight:600; font-size:15px; }
    .feed-date { color:var(--muted); font-size:12px; }
    .feed-image { width:100%; border-radius:10px; margin-top:12px; max-height:420px; object-fit:cover; border: 3px solid #b9b9b9;}
    .feed-meta { display:flex; gap:12px; margin-top:10px; color:var(--muted); font-size:13px; align-items:center; }
    .text-justify {
      text-align: justify;
      font-weight: 400px;
      font-size: medium;
    }

    .input-error {
      border-color: red !important;
      background-color: #ffe6e6;
    }


    .badge-status { font-size:12px; padding:6px 8px; border-radius:999px; }
    .badge-open { background: #e7f7ec; color:#1a7f32; }
    .badge-closed { background:#f8e9e9; color:#a11a1a; }

    

    /* Right sidebar */
    .right-card { padding:14px; margin-bottom: 18px; }

    /* small announcement list */
    .announce-item { border-radius:10px; padding:10px; background:#fff; margin-bottom:10px; box-shadow: 0 3px 10px rgba(15,23,42,0.04); }

    /* Loader overlay */
    #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
    .progress-bar-custom { left: 100px; width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin: auto;}

    /* Responsive tweaks */
    @media (max-width:991px) {
      .app-container { padding: 0 12px; }
      .left-column { display:none; }
      .right-column { display:none; }
    }
  </style>
</head>
<body>

  <!-- Loader (Bootstrap replacement) -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div style="text-align:center;">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div style="font-weight:700; letter-spacing:.6px; margin-bottom:8px;">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES — CAVITE</div>
      <div style="width:360px; margin: auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" style="margin-top:10px; color:#6b7280;">0%</div>
    </div>
  </div>

  <!-- Topbar -->
  <nav class="navbar topbar"
    style="background: linear-gradient(175deg, #882323 55%, #000000 60%);">
    <div class="container">
      <a class="navbar-brand text-white" href="homepage.html">
        <img src="Logo2.png" alt="Logo" style="height:34px; border-radius:6px;">
        <span style="font-weight:600;">TUPC — Cavite Alumni</span>
      </a>

      <form class="d-flex ms-auto me-3 flex-grow-1" role="search" style="max-width: 600px;">
        <input id="feedSearch" 
              class="form-control" 
              type="search" 
              placeholder="🔍 Search events or careers..." 
              oninput="filterFeed()">
      </form>

      <div class="d-flex align-items-center ms-3 gap-2">
        <button class="btn btn-outline-light btn-sm" id="open-login-modal">Log In</button>
        <button class="btn btn-light btn-sm text-primary" id="open-registration-modal">Register</button>
      </div>
    </div>
  </nav>

  <!-- App Container -->
  <div class="app-container">
    <div class="row gx-4">

      <!-- Left Sidebar: shortcuts -->
      <div class="col-lg-3 left-column">
        <div class="left-card">
          <div class="d-flex align-items-center mb-3">
            <img src="Logo2.png" alt="avatar" class="avatar" />
            <div>
              <div style="font-weight:700;">TUPC Alumni</div>
              <div style="color:var(--muted); font-size:13px;">Connect — Find jobs — Stay updated</div>
            </div>
          </div>

          <div class="d-grid gap-2">
            <div class="shortcut-btn" id="careerBtn" role="button"><i class="fa-solid fa-briefcase fa-lg" style="color:#0b5ed7;"></i><div><strong>Career</strong><div class="small" style="color:var(--muted)">Jobs & opportunities</div></div></div>
            <div class="shortcut-btn" id="galleryBtn" role="button"><i class="fa-solid fa-images fa-lg" style="color:#d63384;"></i><div><strong>Gallery</strong><div class="small" style="color:var(--muted)">Event photos</div></div></div>
            <div class="shortcut-btn" id="idBtn" role="button"><i class="fa-solid fa-id-card fa-lg" style="color:#198754;"></i><div><strong>ID Request</strong><div class="small" style="color:var(--muted)">Request your alumni ID</div></div></div>
            <div class="shortcut-btn" id="open-registration-button" role="button" data-bs-toggle="modal" data-bs-target="#registrationModal"><i class="fa-solid fa-user-plus fa-lg" style="color:#0d6efd;"></i><div><strong>Registration</strong><div class="small" style="color:var(--muted)">Alumni & employer</div></div></div>
          </div>

          <hr style="margin:14px 0;border-color:#eef2f6;">
          <div class="small" style="color:var(--muted);">Quick Links</div>
          <ul class="list-unstyled mt-2">
            <li><a href="alumni-registration.html" class="text-decoration-none">Alumni Registration</a></li>
          </ul>
        </div>
      </div>

      <!-- CENTER: feed -->
      <div class="col-lg-6">
        <div id="feed">
          <!-- feed cards populated by JS -->
        </div>
      </div>

      <!-- RIGHT: announcements -->
      <div class="col-lg-3 right-column">
        <div class="right-card mb-3 text-center">
          <img src="Logo2.png" alt="logo" style="max-height:80px; margin-bottom:10px;">
          <div style="font-weight:700;">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES — CAVITE</div>
          <div class="small" style="color:var(--muted); margin-top:6px;">To access Events, Career, and ID Request, please log in or register.</div>
          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-outline-primary btn-sm" id="open-login-modal-2">Log In</button>
            <button class="btn btn-primary btn-sm" id="open-registration-modal-2">Register</button>
          </div>
        </div>

        <div class="right-card mb-3">
          <div style="font-weight:700; margin-bottom:8px;">ID Announcements</div>
          <div id="idAnnouncementList" class="small-muted">
            Loading...
          </div>
        </div>

        <div class="right-card">
          <div style="font-weight:700; margin-bottom:8px;">Events Announcements</div>
          <div id="eventList" class="small-muted">
            Loading...
          </div>
        </div>

        <div class="right-card mt-3">
          <div style="font-weight:700; margin-bottom:8px;">Career Opportunities</div>
          <div id="careerList" class="small-muted">
            Loading...
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- LOGIN Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title">Log In</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="login-form">
            <div class="mb-3">
              <input type="text" id="login-username" class="form-control" placeholder="Enter Username" maxlength="25" required oninput="this.value = formatUsername(this.value)">
            </div>
            <div class="mb-3 position-relative">
              <input type="password" id="login-password" class="form-control" placeholder="Enter Password" required>
              <span id="toggleLoginPassword" class="position-absolute top-50 end-0 translate-middle-y me-3 toggle-icon">⌣</span>
            </div>
            <div id="loginError" class="text-danger small mb-2"></div>
            <div class="d-grid">
              <button class="btn btn-primary" type="submit">Login</button>
            </div>
          </form>

          <div class="text-center mt-3">
            <a href="#" data-bs-toggle="modal" data-bs-target="#forgotModal" data-bs-dismiss="modal">Forgot Password?</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Forgot modal -->
  <div class="modal fade" id="forgotModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title">Forgot Password</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="forgot-step1">
            <label class="form-label small">Enter Username or User ID</label>
            <input id="forgot-username" class="form-control mb-2" placeholder="Enter Username">
            <div class="d-grid">
              <button id="findEmailBtn" class="btn btn-outline-primary">Find Email</button>
            </div>
          </div>

          <div id="emailDisplay" style="display:none; margin-top:10px;">
            <p id="emailFound" class="small"></p>
            <div class="d-grid">
              <button id="sendOtpBtn" class="btn btn-primary">Send OTP</button>
            </div>
          </div>

          <div id="otpSection" style="display:none; margin-top:10px;">
            <input id="otpInput" class="form-control mb-2" placeholder="Enter OTP">
            <div class="d-grid">
              <button id="verifyOtpBtn" class="btn btn-primary">Verify OTP</button>
            </div>
          </div>

          <div id="resetPasswordSection" style="display:none; margin-top:10px;">
            <div class="position-relative mb-2">
              <input id="newPassword" class="form-control" maxlength="15" placeholder="Enter New Password" oninput="filterResetPassword(this)" style="padding-right:54px;">
              <span id="toggleResetPassword" class="position-absolute top-50 end-0 translate-middle-y me-3 toggle-icon">⌣</span>
            </div>
            <div class="d-grid">
              <button id="resetPasswordBtn" class="btn btn-success">Reset Password</button>
            </div>
          </div>

          <div id="forgot-error" class="text-danger small mt-2"></div>
          <div id="forgot-success" class="text-success small mt-2"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Registration selection modal -->
  <div class="modal fade" id="registrationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="modal-header border-0">
          <h5 class="modal-title">Registration</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <a href="alumni-registration.html" class="btn btn-outline-primary w-100 mb-2">Alumni Registration</a>
          <button class="btn btn-outline-primary w-100" id="openEmployerModalBtn" data-bs-toggle="modal" data-bs-target="#employerModal" data-bs-dismiss="modal">Employer Registration</button>
        </div>
      </div>
    </div>
  </div>

<!-- Employer Modal -->
<div class="modal fade" id="employerModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content p-3">
      <div class="modal-header border-0">
        <h5 class="modal-title">Employer Registration</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="employerRegForm">
          <div class="row g-2">
            <div class="col-md-6">
              <input type="text" id="employerName" name="employerName" class="form-control" placeholder="Employer Name" maxlength="30" required oninput="this.value = formatName(this.value)">
            </div>
            <div class="col-md-6">
              <input type="text" id="businessName" name="businessName" class="form-control" placeholder="Business Name" maxlength="40" required oninput="this.value = formatBusinessName(this.value)">
            </div>
            <div class="col-12">
              <input type="text" id="businessAddress" name="businessAddress" class="form-control" placeholder="Business Address" maxlength="100" required oninput="this.value = formatBusinessAddress(this.value)">
            </div>
            <div class="col-md-6">
              <input type="text" id="landlineNo" name="landlineNo" class="form-control" placeholder="Landline Number" maxlength="15" required oninput="var v=this.value.toUpperCase(); if(/^[0-9]*$/.test(v)||/^N$/.test(v)||/^NA$/.test(v)||/^NON?$/.test(v)||/^NONE$/.test(v)){this.value=v;} else{this.value=this.value.replace(/[^0-9]/g,'');}">
            </div>
            <div class="col-md-6">
              <input type="text" id="mobileNo" name="mobileNo" class="form-control" placeholder="Mobile Number" maxlength="12" required oninput="var v=this.value.toUpperCase(); if(/^[0-9]*$/.test(v)||/^N$/.test(v)||/^NA$/.test(v)||/^NON?$/.test(v)||/^NONE$/.test(v)){this.value=v;} else{this.value=this.value.replace(/[^0-9]/g,'');}">
            </div>
            <div class="col-md-6">
              <input type="email" id="companyEmail" name="companyEmail" class="form-control" placeholder="Company Email Address" maxlength="40" required oninput="this.value = formatCompanyEmail(this.value)">
            </div>
            <div class="col-md-6">
              <input type="url" id="companyWebsite" name="companyWebsite" class="form-control" placeholder="Company Website" maxlength="100" required oninput="this.value = this.value.replace(/\s/g,'')">
            </div>
            <div class="col-md-6">
              <input type="text" id="preferredUserId" name="preferredUserId" class="form-control" placeholder="Preferred User ID" maxlength="25" required oninput="this.value = formatUserId(this.value)">
            </div>
            <div class="col-md-6 position-relative">
              <input type="password" id="preferredPassword" name="preferredPassword" class="form-control" placeholder="Preferred User Password" maxlength="15" required oninput="this.value = this.value.replace(/[^a-zA-Z0-9]/g,'')">
              <span id="toggleEmployerPassword" class="position-absolute top-50 end-0 translate-middle-y me-3 toggle-icon">⌣</span>
              <small id="passwordHelp" class="text-danger" style="display:none;">Password must be at least 10 characters</small>
            </div>
          </div>

          <div class="d-grid mt-3">
            <button type="button" id="employerSubmitBtn" class="btn btn-success">Submit Registration</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


  <!-- Toast wrapper -->
  <div id="toastWrapper" style="position: fixed; top: 16px; right: 16px; z-index: 13000;"></div>

  <!-- Custom JS (all backend endpoints preserved) -->
  <script>
  /*******************************
   * Formatting helpers copied from your originals
   *******************************/
  function filterResetPassword(input) {
    input.value = input.value.replace(/[^a-zA-Z0-9]/g, '').slice(0, 15);
  }
  function formatCompanyEmail(value) { return value.replace(/\s/g, ''); }
  function formatBusinessAddress(value) {
    value = value.replace(/[^a-zA-Z0-9. ]/g, '');
    const firstDot = value.indexOf('.');
    if (firstDot !== -1) {
      value = value.substring(0, firstDot + 1) + value.substring(firstDot + 1).replace(/\./g, '');
    }
    return value.replace(/\b\w/g, c => c.toUpperCase());
  }
  function formatBusinessName(value) {
    value = value.replace(/[^a-zA-Z0-9 !@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/g, '');
    const seen = {}; let filtered = '';
    for (let ch of value) {
      if (/[^a-zA-Z0-9\s]/.test(ch)) {
        if (!seen[ch]) { seen[ch]=true; filtered += ch; }
      } else filtered += ch;
    }
    return filtered.replace(/\b\w/g, c => c.toUpperCase());
  }
  function formatUsername(value) {
    value = value.replace(/[^a-zA-Z0-9.]/g, '');
    const firstDot = value.indexOf('.');
    if (firstDot !== -1) {
      value = value.substring(0, firstDot + 1) + value.substring(firstDot + 1).replace(/\./g, '');
    }
    return value;
  }
  function formatUserId(value) {
    value = value.replace(/[^a-zA-Z0-9.]/g, '');
    let firstDotIndex = value.indexOf('.');
    if (firstDotIndex !== -1) {
      value = value.substring(0, firstDotIndex + 1) + value.substring(firstDotIndex + 1).replace(/\./g, '');
    }
    let digitCount = 0;
    value = value.split('').filter(ch => {
      if (/\d/.test(ch)) { digitCount++; return digitCount <= 4; }
      return true;
    }).join('');
    return value;
  }
  function formatName(value) {
    value = value.replace(/[^a-zA-Z\s]/g, '');
    return value.replace(/\b\w/g, c => c.toUpperCase());
  }

  /*******************************
   * Toast helper
   *******************************/
  function showToast(message, type='info', duration=4000) {
    const wrapper = document.getElementById('toastWrapper');
    const id = 't' + Date.now() + Math.floor(Math.random()*1000);
    const bg = (type==='success') ? 'bg-success text-white' : (type==='error' ? 'bg-danger text-white' : (type==='warning' ? 'bg-warning text-dark' : 'bg-info text-white'));
    const el = document.createElement('div');
    el.className = 'toast ' + bg + ' d-flex align-items-center';
    el.style.minWidth = '220px';
    el.style.marginBottom = '8px';
    el.innerHTML = `<div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>`;
    wrapper.appendChild(el);
    const bs = new bootstrap.Toast(el, { delay: duration });
    bs.show();
    el.addEventListener('hidden.bs.toast', () => el.remove());
  }

  /*******************************
   * Loader progress
   *******************************/
  document.addEventListener('DOMContentLoaded', () => {
    let p = 0;
    const bar = document.getElementById('progress-bar');
    const pct = document.getElementById('percentage');
    const wrap = document.getElementById('loader-wrapper');
    const iv = setInterval(() => {
      p = Math.min(100, p + Math.floor(Math.random()*6) + 2);
      bar.style.width = p + '%';
      pct.textContent = p + '%';
      if (p >= 100) {
        clearInterval(iv);
        wrap.style.display = 'none';
      }
    }, 70);
  });

  /*******************************
   * Basic UI wiring (open modals)
   *******************************/
  function openModalById(id){ new bootstrap.Modal(document.getElementById(id)).show(); }
  document.getElementById('open-login-modal').addEventListener('click', () => openModalById('loginModal'));
  document.getElementById('open-login-modal-2').addEventListener('click', () => openModalById('loginModal'));
  document.getElementById('open-registration-modal').addEventListener('click', () => openModalById('registrationModal'));
  document.getElementById('open-registration-modal-2').addEventListener('click', () => openModalById('registrationModal'));

  // Left shortcut buttons
  document.getElementById('careerBtn').addEventListener('click', () => {
    document.getElementById('warnOverlay')?.classList?.add('show');
    // show small warn popup similar behaviour
    showToast('⚠️ Career requires login. Please sign in.', 'warning', 3000);
  });
  document.getElementById('galleryBtn').addEventListener('click', () => window.location.href = 'gallery-user.html?from=homepage.html');
  document.getElementById('idBtn').addEventListener('click', () => {
    showToast('⚠️ ID Request requires login. Please sign in.', 'warning', 3000);
  });

  /*******************************
   * Toggle password icons
   *******************************/
  const toggleLoginPassword = document.getElementById('toggleLoginPassword');
  const loginPasswordInput = document.getElementById('login-password');
  if (toggleLoginPassword && loginPasswordInput) {
    toggleLoginPassword.addEventListener('click', () => {
      const isPassword = loginPasswordInput.type === 'password';
      loginPasswordInput.type = isPassword ? 'text' : 'password';
      toggleLoginPassword.textContent = isPassword ? '👁️' : '⌣';
    });
  }
  const toggleResetPassword = document.getElementById('toggleResetPassword');
  const newPasswordInput = document.getElementById('newPassword');
  if (toggleResetPassword && newPasswordInput) {
    toggleResetPassword.addEventListener('click', () => {
      const is = newPasswordInput.type === 'password';
      newPasswordInput.type = is ? 'text' : 'password';
      toggleResetPassword.textContent = is ? '👁️' : '⌣';
    });
  }
  document.getElementById('toggleEmployerPassword')?.addEventListener('click', () => {
    const e = document.getElementById('preferredPassword');
    if (!e) return;
    const is = e.type === 'password';
    e.type = is ? 'text' : 'password';
    document.getElementById('toggleEmployerPassword').textContent = is ? '👁️' : '⌣';
  });

  /*******************************
   * LOGIN — tries alumni/admin then employer (endpoints preserved)
   *******************************/
  document.getElementById('login-form').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const u = document.getElementById('login-username').value.trim();
    const p = document.getElementById('login-password').value.trim();
    const loginError = document.getElementById('loginError');
    loginError.textContent = '';

    if (!u || !p) {
      loginError.textContent = 'Enter both username & password';
      showToast('⚠️ Enter both username & password', 'warning');
      return;
    }

    try {
      const r = await fetch('/api/registration/login', {
        method: 'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userName: u, passWord: p })
      });
      const d = await r.json();
      if (!r.ok) throw new Error(d.error || 'Login failed');

      const role = d.isAdmin ? 'admin' : 'user';
      sessionStorage.setItem('userRole', role);
      sessionStorage.setItem('userName', u);
      if (d.user && d.user.id) sessionStorage.setItem('userId', d.user.id);

      if (d.user && d.user.firstName) sessionStorage.setItem('firstName', d.user.firstName);
      if (d.user && d.user.lastName) sessionStorage.setItem('lastName', d.user.lastName);
      if (d.user && d.user.personalEmail) sessionStorage.setItem('userEmail', d.user.personalEmail); // <-- THIS IS CRUCIAL

      showToast('✅ Login successful!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
      setTimeout(() => {
        window.location.href = (role === 'admin' ? 'admin-homepage.html' : 'user-homepage.html');
      }, 700);
      return;
    } catch (err) {
      try {
        // employer fallback
        const r2 = await fetch('/api/employer/login', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId:u, password:p })
        });
        const d2 = await r2.json();
        if (!r2.ok) throw new Error(d2.error || 'Employer login failed');

        sessionStorage.setItem('userRole','employer');
        sessionStorage.setItem('userName', d2.employerName || u);
        sessionStorage.setItem('userId', d2.userId || '');
        if (d2.employerId) localStorage.setItem('employerId', d2.employerId);

        showToast('✅ Employer login successful!', 'success');
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        setTimeout(()=> window.location.href='employer-page.html', 700);
        return;
      } catch (err2) {
        console.error('Login failed', err2);
        loginError.textContent = err2.message || 'Login failed';
        showToast('❌ ' + (err2.message || 'Login failed'), 'error');
      }
    }
  });
  

  /*******************************
   * FORGOT PASSWORD flow (preserve endpoints)
   * POST /api/forgot/find-user
   * POST /api/employer/forgot/employer-user
   * POST /api/forgot/send-otp
   * POST /api/forgot/verify-otp
   * POST /api/forgot/reset-password
   *******************************/
  let currentUser = '';
  let userType = '';

  document.getElementById('forgotModal').addEventListener('show.bs.modal', () => {
    document.getElementById('forgot-username').value = '';
    document.getElementById('emailDisplay').style.display = 'none';
    document.getElementById('otpSection').style.display = 'none';
    document.getElementById('resetPasswordSection').style.display = 'none';
    document.getElementById('forgot-error').textContent = '';
    document.getElementById('forgot-success').textContent = '';
    currentUser = ''; userType = '';
  });

  document.getElementById('findEmailBtn').addEventListener('click', async () => {
    const username = document.getElementById('forgot-username').value.trim();
    const err = document.getElementById('forgot-error'); const suc = document.getElementById('forgot-success');
    err.textContent=''; suc.textContent='';
    document.getElementById('emailDisplay').style.display = 'none';
    if (!username) return err.textContent = 'Please enter a username or User ID';

    try {
      const res = await fetch('/api/forgot/find-user', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ userName: username })
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Not found');
      document.getElementById('emailFound').textContent = `Gmail found (Alumni): ${data.email}`;
      document.getElementById('emailDisplay').style.display = 'block';
      currentUser = username; userType = 'alumni';
      showToast('✅ Alumni email found', 'success');
    } catch (err1) {
      try {
        const res2 = await fetch('/api/employer/forgot/employer-user', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ userId: username })
        });
        const data2 = await res2.json();
        if (!res2.ok) throw new Error(data2.error || 'Not found');
        document.getElementById('emailFound').textContent = `Gmail found (Employer): ${data2.email}`;
        document.getElementById('emailDisplay').style.display = 'block';
        currentUser = username; userType = 'employer';
        showToast('✅ Employer email found', 'success');
      } catch (err2) {
        err.textContent = '❌ ' + (err2.message || err1.message || 'Not found');
      }
    }
  });

  document.getElementById('sendOtpBtn').addEventListener('click', async () => {
    const err = document.getElementById('forgot-error'); const suc = document.getElementById('forgot-success');
    err.textContent=''; suc.textContent='';
    try {
      const bodyData = userType === 'alumni' ? { userName: currentUser } : { userId: currentUser };
      const res = await fetch('/api/forgot/send-otp', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyData)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Failed to send OTP');
      suc.textContent = 'OTP has been sent to your email!';
      document.getElementById('otpSection').style.display = 'block';
      showToast('✅ OTP sent', 'success');
    } catch (err) {
      err.textContent = err.message || 'Failed to send OTP';
    }
  });

  document.getElementById('verifyOtpBtn').addEventListener('click', async () => {
    const otp = document.getElementById('otpInput').value.trim();
    const err = document.getElementById('forgot-error'); const suc = document.getElementById('forgot-success');
    err.textContent=''; suc.textContent='';
    if (!otp) return err.textContent = 'Please enter the OTP';
    try {
      const bodyData = userType === 'alumni' ? { userName: currentUser, otp } : { userId: currentUser, otp };
      const res = await fetch('/api/forgot/verify-otp', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyData)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'OTP verify failed');
      suc.textContent = 'OTP verified! You can now reset your password.';
      document.getElementById('resetPasswordSection').style.display = 'block';
      showToast('✅ OTP verified', 'success');
    } catch (err) {
      err.textContent = err.message || 'OTP verify failed';
    }
  });

  document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
    const newPassword = document.getElementById('newPassword').value.trim();
    const err = document.getElementById('forgot-error'); const suc = document.getElementById('forgot-success');
    err.textContent=''; suc.textContent='';
    if (!newPassword) return err.textContent = 'Please enter a new password';
    try {
      const bodyData = userType === 'alumni' ? { userName: currentUser, newPassword } : { userId: currentUser, newPassword };
      const res = await fetch('/api/forgot/reset-password', {
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(bodyData)
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Reset failed');
      suc.textContent = 'Password reset successfully!';
      showToast('✅ Password reset', 'success');
      setTimeout(()=> bootstrap.Modal.getInstance(document.getElementById('forgotModal')).hide(), 1000);
    } catch (err) {
      err.textContent = err.message || 'Reset failed';
    }
  });

  /*******************************
   * Employer Registration
   * POST /api/employer/employers
   *******************************/
document.getElementById('employerSubmitBtn').addEventListener('click', async () => {
  const form = document.getElementById('employerRegForm');

  const fields = [
    'employerName', 'businessName', 'businessAddress',
    'landlineNo', 'mobileNo', 'companyEmail',
    'companyWebsite', 'preferredUserId', 'preferredPassword'
  ];

  let hasError = false;

  // Reset previous error styles
  fields.forEach(id => {
    document.getElementById(id).classList.remove('input-error');
  });
  document.getElementById('passwordHelp').style.display = 'none';

  const data = {};
  fields.forEach(id => {
    const el = document.getElementById(id);
    data[id] = el.value.trim();
    if (!data[id]) {
      el.classList.add('input-error');
      hasError = true;
    }
  });

  if (hasError) {
    return showToast('⚠️ Fill all required fields', 'warning');
  }

  if (!data.preferredUserId.endsWith('.employer')) {
    document.getElementById('preferredUserId').classList.add('input-error');
    return showToast('ID must end with ".employer"', 'error');
  }

  if (data.preferredPassword.length < 10) {
    document.getElementById('preferredPassword').classList.add('input-error');
    document.getElementById('passwordHelp').style.display = 'block';
    return showToast('❗ Password must be at least 10 characters', 'warning');
  }

  try {
    const r = await fetch('/api/employer/employers', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(data)
    });
    const d = await r.json();
    if (!r.ok) throw new Error(d.error || 'Failed');

    showToast('✅ Employer request sent', 'success');
    form.reset();
    bootstrap.Modal.getInstance(document.getElementById('employerModal')).hide();

    // Remove error styles after successful submission
    fields.forEach(id => document.getElementById(id).classList.remove('input-error'));
  } catch (err) {
    showToast('❌ ' + (err.message || 'Failed'), 'error');
  }
});


  /*******************************
   * Feed loader: GET /api/events
   * Center feed shows events + careers + ID announcements (we'll fetch events and announcements and merge)
   *******************************/
  function parseFlexibleDateTime(input) {
    if (!input && input !== 0) return null;
    if (input instanceof Date) return isNaN(input.getTime()) ? null : input;
    if (typeof input === 'number' || /^\d+$/.test(String(input).trim())) {
      const d = new Date(Number(input)); if (!isNaN(d.getTime())) return d;
    }
    const s = String(input).trim();
    const isoMatch = s.match(/^(\d{4})-(\d{1,2})-(\d{1,2})[T\s](\d{1,2}):(\d{2})(?::(\d{2}))?$/);
    if (isoMatch) {
      const [, yy, mm, dd, hh, min, sec='0'] = isoMatch;
      return new Date(Number(yy), Number(mm)-1, Number(dd), Number(hh), Number(min), Number(sec));
    }
    const fallback = new Date(s); return isNaN(fallback.getTime()) ? null : fallback;
  }

async function loadFeed() {
  const feedContainer = document.getElementById('feed');
  feedContainer.innerHTML = '<div class="text-muted">Loading feed...</div>';
  try {
    const eventsRes = await fetch('/api/events');
    if (!eventsRes.ok) throw new Error('Failed to fetch events');
    const { events } = await eventsRes.json();

    if (!events || !events.length) {
      feedContainer.innerHTML = '<div class="text-muted">No posts</div>';
      return;
    }

    const now = Date.now();

    // Separate active and closed events
    const activeEvents = [];
    const closedEvents = [];

    events.forEach(post => {
      let raw = post.eventDateTime || post.datePosted || '';
      if (raw.endsWith && raw.endsWith('Z')) raw = raw.replace('Z','');
      const deadline = parseFlexibleDateTime(raw);
      const deadlineMs = deadline ? deadline.getTime() : 0;

      const isClosed = deadline && deadlineMs <= now;

      const feedHtml = `
        <article class="feed-card">
          <div class="feed-header">
            <img src="Logo2.png" class="avatar1" alt="avatar1">
            <div>
              <div class="feed-title" style="text-align:justify; word-break:break-word; white-space:pre-line;">
                ${(post.title || 'Untitled Event')}
              </div>
              <div class="feed-date">${new Date(post.datePosted).toLocaleString()}</div>
            </div>
          </div>

          ${post.image ? `<img src="${post.image}" class="feed-image" alt="event image" onerror="this.style.display='none'">` : ''}

          <div style="margin-top:10px;">
            <div class="small text-justify" style="color:var(--muted);">${post.description || ''}</div>
          </div>

          <div class="feed-meta">
            <div style="text-align:justify; word-break:break-word; white-space:pre-line;">
              <i>🎉</i>&nbsp; ${post.location || 'N/A'}
            </div>
          </div>

          <!-- Countdown + Status at the bottom -->
          <div class="feed-footer" style="margin-top:8px; text-align:right; font-size:0.9rem; color:var(--muted);">
            ⏳ <span class="countdown" data-time="${deadlineMs}" id="count-${post.id}"></span>
            <span class="badge-status ${isClosed ? 'badge-closed' : 'badge-open'}" style="margin-left:8px;">
              ${isClosed ? 'CLOSE' : 'ACTIVE'}
            </span>
          </div>
        </article>
      `;



      if (isClosed) closedEvents.push(feedHtml);
      else activeEvents.push(feedHtml);
    });

    // Combine: active first, closed last
    feedContainer.innerHTML = [...activeEvents, ...closedEvents].join('');

    // Countdown updater
    function updateCountdowns() {
      const now = Date.now();
      document.querySelectorAll('.countdown').forEach(el => {
        const ms = Number(el.dataset.time);
        if (!ms || isNaN(ms)) { el.textContent = '—'; return; }
        const diff = ms - now;
        if (diff <= 0) { el.textContent = '❌ Closed'; return; }
        const days = Math.floor(diff / (1000*60*60*24));
        const hours = Math.floor((diff % (1000*60*60*24)) / (1000*60*60));
        const minutes = Math.floor((diff % (1000*60*60)) / (1000*60));
        const seconds = Math.floor((diff % (1000*60)) / 1000);
        el.textContent = days > 0 ? `${days}d ${hours}h ${minutes}m ${seconds}s left` : `${hours}h ${minutes}m ${seconds}s left`;
      });
    }
    updateCountdowns();
    setInterval(updateCountdowns, 1000);

  } catch (err) {
    console.error(err);
    feedContainer.innerHTML = '<div class="text-danger">Failed to load feed.</div>';
    showToast('⚠️ Failed to load feed', 'error');
  }
}


  /*******************************
   * Announcements loader (preserve endpoints)
   * /api/admin/id-announcements
   * /api/events
   * /api/careers or /api/careers/all or /api/careers/public
   *******************************/
  async function loadAnnouncements() {
    try {
      const role = sessionStorage.getItem('userRole');
      const careersUrl = role === 'admin' ? '/api/careers/all' : (role === 'employer' ? '/api/careers' : '/api/careers/public');

      const [r1, r2, r3] = await Promise.all([
        fetch('/api/admin/id-announcements'),
        fetch('/api/events'),
        fetch(careersUrl)
      ]);

      const idA = (await r1.json()).announcements || [];
      const events = (await r2.json()).events || [];
      const careers = (await r3.json()).careers || [];

      document.getElementById('idAnnouncementList').innerHTML =
        idA.map(a => `
        <div class="announce-item">
            <div style="font-weight:600">${a.title}</div>
            <div class="small-muted">Posted: ${new Date(a.datePosted).toLocaleDateString()}</div>
            <div class="small-muted mt-1" style="text-align: justify;">${a.description}</div>
          </div>
        `).join('') || '<div class="text-muted">No ID announcements</div>';

      document.getElementById('eventList').innerHTML =
        events.map(e => `<div class="announce-item"><div style="font-weight:600">${e.title}</div><div class="small-muted">Posted: ${new Date(e.datePosted).toLocaleDateString()}</div><div class="small">${e.location||''}</div></div>`).join('') || '<div class="text-muted">No events</div>';

      document.getElementById('careerList').innerHTML =
        careers.map(c => `<div class="announce-item"><div style="font-weight:600">${c.title}</div><div class="small-muted">Posted: ${new Date(c.datePosted).toLocaleDateString()}</div></div>`).join('') || '<div class="text-muted">No careers</div>';

    } catch (err) {
      console.error('Failed to load announcements', err);
      showToast('⚠️ Failed to load announcements', 'error');
    }
  }

  /*******************************
   * Page restriction (preserve original)
   *******************************/
  (function pageRestriction(){
    try {
      const role = sessionStorage.getItem('userRole');
      const currentPage = window.location.pathname.split('/').pop();
      if (!['admin','employer','user'].includes(role) && currentPage !== 'homepage.html' && currentPage !== '') {
        // keep on homepage
      }
    } catch(e){}
  })();

  /*******************************
   * Init on DOMContentLoaded
   *******************************/
  document.addEventListener('DOMContentLoaded', () => {
    loadAnnouncements();
    loadFeed();
  });

    function filterFeed() {
    const query = document.getElementById('feedSearch').value.toLowerCase();
    document.querySelectorAll('.feed-card').forEach(card => {
      const text = card.innerText.toLowerCase();
      card.style.display = text.includes(query) ? 'block' : 'none';
    });
  }
  window.filterFeed = filterFeed;
  
  </script>
</body>
</html>