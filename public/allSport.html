<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sportfest Registrations Dashboard</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Alegreya:wght@400;500;700&family=Albert+Sans:wght@400;500;700&family=Sanchez&display=swap" rel="stylesheet"/>

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>

  <link rel="icon" type="image/png" href="/Logo2.png">

  <style>
    :root {
      --accent: #0d6efd;
      --bg: #f8f9fa;
    }
    body {
      font-family: 'Albert Sans', sans-serif;
      background: var(--bg);
      color: #222;
    }

    /* Loader overlay */
    #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
    .progress-bar-custom { left: 100px; width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin: auto;}


    /* Navbar */
    .navbar-brand img { height:40px; }

    /* Page title */
    .page-title { font-weight:700; margin-top:1rem; text-align:center; }

    /* Status badges */
    .badge-status { font-weight:700; padding:.35em .6em; border-radius:.375rem; display:inline-block; }
    .badge-PENDING { background:#fff3cd; color:#856404; }
    .badge-ACCEPTED { background:#d1e7dd; color:#0f5132; }
    .badge-DECLINED { background:#f8d7da; color:#842029; }

    /* Popup */
    .popup-warning {
      position: fixed; bottom:20px; right:20px;
      background:#ffc107; color:#000; padding:10px 14px; border-radius:6px; box-shadow:0 6px 18px rgba(0,0,0,.12);
      display:none; z-index:3200;
    }
    .popup-warning.show { display:block; }

/* Print styles: show only printZone and hide unnecessary columns */
@media print {
  /* Hide everything outside printZone */
  body * {
    visibility: hidden !important;
  }

  /* Only show printZone */
  #printZone,
  #printZone * {
    visibility: visible !important;
  }

  /* Position table to top-left */
  #printZone {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
  }

  /* Remove scroll wrapper */
  #printZone .table-responsive {
    overflow: visible !important;
  }

  /* Table formatting */
  #athleteTable {
    width: 100% !important;
    border-collapse: collapse !important;
    margin: 50 !important; /* aligned left */
    table-layout: auto !important;
  }

  #athleteTable thead th,
  #athleteTable tbody td {
    border: 1px solid #000 !important;
    padding: 6px !important;
    text-align: left !important;
    word-wrap: break-word !important;
    white-space: normal !important;
  }

  /* Dark header */
  #athleteTable thead th {
    background-color: #000 !important;
    color: #fff !important;
    -webkit-print-color-adjust: exact !important;
    print-color-adjust: exact !important;
  }

  /* Hide action buttons */
  #athleteTable .action-btn {
    display: none !important;
  }

  /* Hide the Response column (last column) */
  #athleteTable th:last-child,
  #athleteTable td:last-child {
    display: none !important;
  }
}



    /* Controls minimum widths for nicer layout */
    .controls-row .form-control, .controls-row .form-select { min-width:160px; }
  </style>
</head>
<body>


  <!-- Navbar (basketball-style) -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid px-3">
      <a class="navbar-brand d-flex align-items-center" href="admin-homepage.html">
        <img src="Logo.png" alt="Logo" class="me-2"><span>TUPC Events</span>
      </a>
      <div class="ms-auto d-flex gap-2 align-items-center">
        <!-- sport dropdown placed in navbar too (keeps behavior) -->
        <select id="sportSelectNav" class="form-select form-select-sm" style="width:180px;">
          <option value="" disabled selected>Sport Fest</option>
          <option value="mensBasketball">Men's Basketball</option>
          <option value="womensVolleyball">Women's Volleyball</option>
          <option value="mensVolleyball">Men's Volleyball</option>
          <option value="chess">Chess</option>
          <option value="darts">Darts</option>
        </select>

        <button class="btn btn-outline-light" onclick="location.href='event-registration.html'">
          <i class="fas fa-arrow-left"></i> Back
        </button>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <div class="container text-center mt-4">
    <h2 class="page-title">Sport Fest Registrations</h2>
  </div>

  <!-- Controls -->
  <div class="container mt-3">
    <div class="row controls-row g-2 align-items-center">
      <div class="col-md-4 col-sm-12">
        <input id="searchInput" class="form-control" placeholder="Search by name…" />
      </div>

      <div class="col-md-3 col-sm-6">
        <select id="sportFilter" class="form-select">
          <option value="ALL">All Sports</option>
        </select>
      </div>

      <div class="col-md-2 col-sm-6">
        <select id="pageSelect" class="form-select"></select>
      </div>

      <div class="col-md-3 col-sm-12 text-md-end">
        <button id="printBtn" class="btn btn-primary w-100"><i class="fas fa-print"></i> Print Accepted Only</button>
      </div>
    </div>
  </div>

  <!-- Print header shown only while printing -->
  <h4 id="printTitle" class="text-center mt-3 d-none">Accepted Sportfest Registrations</h4>

  <!-- Table / print zone -->
  <div id="printZone" class="container mt-3">
    <div class="table-responsive">
      <table id="athleteTable" class="table table-bordered table-hover align-middle">
        <thead class="table-dark">
        <tr>
          <th>FULL NAME</th>
          <th>GENDER</th>
          <th>SUFFIX</th>
          <th>YEAR GRADUATED</th>
          <th>SPORT</th>
          <th>DATE OF SUBMISSION</th>
          <th>STATUS</th>
          <th>RESPONSE</th>
        </tr>
        </thead>
        <tbody id="athleteTableBody">
          <tr><td colspan="10">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </div>
    <!-- Loader (Bootstrap replacement) -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div style="text-align:center;">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div style="font-weight:700; letter-spacing:.6px; margin-bottom:8px;">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES — CAVITE</div>
      <div style="width:360px; margin: auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" style="margin-top:10px; color:#6b7280;">0%</div>
    </div>
  </div>

  <!-- popup -->
  <div id="receiptWarningPopup" class="popup-warning">⚠️ No data / action available</div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Converted JS (keeps backend endpoints same) -->
  <script>
  (function () {
    const tbody = document.getElementById('athleteTableBody');
    const searchInput = document.getElementById('searchInput');
    const sportFilter = document.getElementById('sportFilter');
    const pageSelect = document.getElementById('pageSelect');
    const printBtn = document.getElementById('printBtn');
    const popup = document.getElementById('receiptWarningPopup');
    const sportSelectNav = document.getElementById('sportSelectNav');
    const printTitle = document.getElementById('printTitle');

    const ROWS_PER_PAGE = 100;
    let currentPage = 1, totalPages = 1, rows = [], showOnlyAccepted = false;

    function formatSportType(raw) {
      const map = {
        mensBasketball: "Men's Basketball",
        womensVolleyball: "Women's Volleyball",
        mensVolleyball: "Men's Volleyball",
        chess: "Chess",
        darts: "Darts"
      };
      return map[raw] || raw || '—';
    }

    function formatDate(raw) {
      return raw ? new Date(raw).toLocaleDateString('en-US', {
        month: 'long', day: '2-digit', year: 'numeric'
      }) : '—';
    }

    // load distinct sports into sportFilter dropdown
    async function loadDistinctSports() {
      try {
        const res = await fetch('/api/allsport/distinct-sports');
        if (!res.ok) throw new Error('Failed to load distinct sports');
        const json = await res.json();
        if (!json || !Array.isArray(json.sports)) return;
        json.sports.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s;
          opt.textContent = formatSportType(s);
          sportFilter.appendChild(opt);
        });
      } catch (err) {
        console.error('Failed to load sports:', err);
      }
    }

    // load page rows
    async function loadPage() {
      try {
        const search = encodeURIComponent(searchInput.value.trim());
        const url = `/api/allsport?page=${currentPage}&limit=${ROWS_PER_PAGE}${search ? `&search=${search}` : ''}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch data');
        const json = await res.json();
        rows = json.rows || [];
        totalPages = json.totalPages || 1;
        buildPagination();
        renderTable();
      } catch (err) {
        console.error('loadPage error:', err);
        tbody.innerHTML = `<tr><td colspan="10">❌ Failed to load data</td></tr>`;
      }
    }

    function buildPagination() {
      pageSelect.innerHTML = '';
      for (let i=1; i<=Math.max(1, totalPages); i++) {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `Page ${i}`;
        if (i === currentPage) opt.selected = true;
        pageSelect.appendChild(opt);
      }
    }

    function statusBadge(status) {
      const s = (status || 'PENDING').toUpperCase();
      if (s === 'ACCEPTED') return `<span class="badge-status badge-ACCEPTED">ACCEPTED</span>`;
      if (s === 'DECLINED') return `<span class="badge-status badge-DECLINED">DECLINED</span>`;
      return `<span class="badge-status badge-PENDING">PENDING</span>`;
    }

    function renderTable() {
      const filter = sportFilter.value || 'ALL';
      tbody.innerHTML = '';

      // sort order: PENDING, ACCEPTED, DECLINED
      const order = { 'PENDING': 1, 'ACCEPTED': 2, 'DECLINED': 3 };

      const filtered = rows
        .filter(r => (filter === 'ALL' || r.sportType === filter))
        .sort((a,b) => (order[(a.status||'PENDING').toUpperCase()] - order[(b.status||'PENDING').toUpperCase()]));

      filtered.forEach(r => {
        const status = (r.status || 'PENDING').toUpperCase();
        if (showOnlyAccepted && status !== 'ACCEPTED') return;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${[r.firstName, r.middleName, r.lastName].filter(Boolean).join(" ")}</td>
          <td>${r.gender || ''}</td>
          <td>${r.extension || ''}</td>
          <td>${r.yearGraduated || ''}</td>
          <td>${formatSportType(r.sportType)}</td>
          <td>${formatDate(r.submittedAt)}</td>
          <td class="text-center">${statusBadge(status)}</td>
          <td class="text-center">
            <button class="btn btn-success btn-sm me-1 action-btn accept-btn">ACCEPT</button>
            <button class="btn btn-danger btn-sm action-btn decline-btn">DECLINE</button>
          </td>
        `;
        tbody.appendChild(tr);

        // attach action listeners
        const id = r.id || r._id;
        const acceptBtn = tr.querySelector('.accept-btn');
        const declineBtn = tr.querySelector('.decline-btn');

        if (acceptBtn) acceptBtn.addEventListener('click', () => updateStatus(id, 'ACCEPTED'));
        if (declineBtn) declineBtn.addEventListener('click', () => updateStatus(id, 'DECLINED'));
      });

      // if nothing to show
      if (!tbody.querySelector('tr')) {
        tbody.innerHTML = '<tr><td colspan="10">No results.</td></tr>';
      }
    }

    async function updateStatus(id, newStatus) {
      try {
        const res = await fetch(`/api/allsport/${id}/status`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        if (!res.ok) {
          const text = await res.text();
          throw new Error(text || 'Update failed');
        }
        // update in local rows and re-render
        const row = rows.find(r => (r.id === id || r._id === id));
        if (row) row.status = newStatus;
        renderTable();
      } catch (err) {
        alert('❌ ' + err.message);
      }
    }

    // Print accepted only -> set flag, show print title, render, print, restore
    printBtn.addEventListener('click', () => {
      showOnlyAccepted = true;
      printTitle.classList.remove('d-none');
      renderTable();
      setTimeout(() => window.print(), 100);
    });

    window.addEventListener('afterprint', () => {
      showOnlyAccepted = false;
      printTitle.classList.add('d-none');
      renderTable();
    });

    // events
    searchInput.addEventListener('input', () => { currentPage = 1; loadPage(); });
    sportFilter.addEventListener('change', () => { currentPage = 1; loadPage(); });
    pageSelect.addEventListener('change', () => { currentPage = +pageSelect.value; loadPage(); });

    // sport nav select behavior (keeps original)
    sportSelectNav.addEventListener('change', function () {
      const sport = this.value;
      const allowed = ['womensVolleyball', 'mensVolleyball', 'chess', 'darts'];
      if (allowed.includes(sport)) {
        const target = new URL('allSport.html', window.location.origin);
        target.searchParams.set('sportType', sport);
        window.location.href = target.toString();
      } else if (sport === 'mensBasketball') {
        window.location.href = 'mensBasketball.html';
      }
    });


    // admin check
    const role = sessionStorage.getItem('userRole');
    if (role !== 'admin') {
      window.location.href = 'homepage.html';
    }

  /*******************************
   * Loader progress
   *******************************/
  document.addEventListener('DOMContentLoaded', () => {
    let p = 0;
    const bar = document.getElementById('progress-bar');
    const pct = document.getElementById('percentage');
    const wrap = document.getElementById('loader-wrapper');
    const iv = setInterval(() => {
      p = Math.min(100, p + Math.floor(Math.random()*6) + 2);
      bar.style.width = p + '%';
      pct.textContent = p + '%';
      if (p >= 100) {
        clearInterval(iv);
        wrap.style.display = 'none';
      }
    }, 70);
  });


    // init
    window.addEventListener('DOMContentLoaded', async () => {
      await loadDistinctSports();
      await loadPage();
    });
  })();
  </script>
</body>
</html>
