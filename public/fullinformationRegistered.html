<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>FULL INFORMATION REGISTERED | TUP - Cavite</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
  body { background:#bebebe; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; }
  .topbar { background: linear-gradient(175deg, #882323 55%, #000000 60%); }
  .card-surface { background:#fff; border:1px solid #eef2f6; border-radius:10px; box-shadow:0 6px 18px rgba(16,24,40,0.04); }
  .form-control, .form-select { border-radius:8px; }
  .table thead th { font-size: .85rem; border-bottom:2px solid #000; }
  .table td, .table th { font-size:.82rem; }
  #loader-wrapper { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; flex-direction:column; background:rgb(230, 230, 230); z-index:1400; }
  .progress-bar-custom { width:0%; height:10px; background-color: maroon; border-radius:6px; transition: width .2s linear; margin:auto; }

  /* Print table only */
  @media print {
    body * { visibility: hidden; }
    #registeredTable, #registeredTable * { visibility: visible; }
    #registeredTable { position:absolute; left:0; top:0; width:100%; }
  }
</style>
</head>
<body>
  <!-- Topbar -->
  <nav class="topbar py-2 mb-3">
    <div class="container d-flex align-items-center gap-3">
        <a class="btn btn-outline-light btn-sm" href="data-registration.html">
          <i class="fa-solid fa-arrow-left"></i>
        </a>
      <div>
        <div class="fw-bold text-white">
          TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES – CAVITE
        </div>
        <div class="small-muted text-white">
          ID Request Database — Admin
        </div>
      </div>
      <button id="printTableBtn" class="btn btn-light btn-sm ms-auto"><i class="fa-solid fa-print me-1"></i></button>
    </div>
  </nav>

  <!-- Main -->
  <main class="container mb-5">
    <div class="row g-4">
      <div class="col-12">
        <div class="card-surface p-3">
          <div class="d-flex flex-wrap gap-2 mb-3">
            <input id="searchInput" class="form-control me-auto" placeholder="Search..." style="max-width:300px;">
            <select id="pageSelect" class="form-select" style="max-width:120px;"></select>
          </div>
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="registeredTable">
              <thead class="table-light">
                <tr>
                  <th>Profile</th>
                  <th>First Name</th>
                  <th>Last Name</th>
                  <th>Initial</th>
                  <th>Suffix</th>
                  <th>Gender</th>
                  <th>Civil Status</th>
                  <th>Date of Birth</th>
                  <th>Maiden</th>
                  <th>Phone No.</th>
                  <th>Major</th>
                  <th>Year Started</th>
                  <th>Graduated</th>
                  <th>Student No.</th>
                </tr>
              </thead>
              <tbody id="registeredTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Loader -->
  <div id="loader-wrapper" role="status" aria-live="polite">
    <div class="text-center">
      <img src="Logo2.png" alt="logo" style="height:60px; margin-bottom:10px;">
      <div class="fw-bold mb-2">TECHNOLOGICAL UNIVERSITY OF THE PHILIPPINES — CAVITE</div>
      <div style="width:360px; margin:auto; background:#f0f2f5; border-radius:8px; padding:6px;">
        <div id="progress-bar" class="progress-bar-custom"></div>
      </div>
      <div id="percentage" class="mt-2 text-muted">0%</div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.querySelector('#registeredTable tbody');
  const printBtn = document.getElementById('printTableBtn');
  const pageSelect = document.getElementById('pageSelect');
  const searchInput = document.getElementById('searchInput');

  const ROWS_PER_PAGE = 100;
  let currentPage = 1;
  let totalPages = 1;

  if (sessionStorage.getItem('userRole') !== 'admin') {
    window.location.href = 'homepage.html';
    return;
  }

  const debounce = (func, wait) => { let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this,args), wait); }; };
  searchInput.addEventListener('input', debounce(() => loadPage(1, searchInput.value.trim()), 300));
  pageSelect.addEventListener('change', () => loadPage(+pageSelect.value, searchInput.value.trim()));
  printBtn.addEventListener('click', () => window.print());

  function formatDate(d){ if(!d) return ''; const dt = new Date(d); if(isNaN(dt)) return d; return dt.toLocaleDateString('en-US', { year:'numeric', month:'long', day:'numeric' }); }

  async function loadPage(page=1, search='') {
    currentPage = page;
    const url = `/api/fullInformation?page=${page}&limit=${ROWS_PER_PAGE}&search=${encodeURIComponent(search)}`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error(await res.text());
      const { rows=[], totalPages: tp=1 } = await res.json();
      totalPages = tp;

      tbody.innerHTML = '';
      rows.forEach(r => {
        const tr = document.createElement('tr');

        // Profile
        const tdPic = document.createElement('td');
        if (r.profilePic) {
          const img = document.createElement('img');
          img.src = r.profilePic;
          img.alt = "Profile Picture";
          img.style.width = "40px";
          img.style.height = "40px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "50%";
          img.style.cursor = "pointer";
          img.addEventListener("click",()=>window.open(r.profilePic,"_blank"));
          tdPic.appendChild(img);
        } else tdPic.textContent = "No Picture";
        tr.appendChild(tdPic);

        ['firstName','lastName','initial','suffix','gender','civilStatus','dateBirth','maiden','phoneNo','major','yearStarted','graduated','studentNo'].forEach(key=>{
          const td = document.createElement('td');
          td.textContent = key==='dateBirth'?formatDate(r[key]):r[key]||'';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      pageSelect.innerHTML='';
      for(let i=1;i<=totalPages;i++){
        const opt = new Option(`Page ${i}`,i,i===currentPage,i===currentPage);
        pageSelect.appendChild(opt);
      }
    } catch(e){
      console.error(e);
      tbody.innerHTML='<tr><td colspan="14">Error loading data</td></tr>';
    }
  }

  // Loader animation
  let pct=80;
  const loaderWrapper = document.getElementById("loader-wrapper");
  const progressBar = document.getElementById("progress-bar");
  const percentageText = document.getElementById("percentage");
  if(loaderWrapper && progressBar && percentageText){
    const interval = setInterval(()=>{
      if(pct<100){ pct++; progressBar.style.width=pct+"%"; percentageText.textContent=pct+"%"; } 
      else{ clearInterval(interval); loaderWrapper.style.display="none"; }
    },30);
  }

  loadPage();
});
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
